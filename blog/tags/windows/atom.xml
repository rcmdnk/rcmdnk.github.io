<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Windows | rcmdnk's blog]]></title>
  <link href="https://rcmdnk.com/blog/tags/windows/atom.xml" rel="self"/>
  <link href="https://rcmdnk.com/"/>
  <updated>2020-08-09T10:06:03+00:00</updated>
  <id>https://rcmdnk.com/</id>
  <author>
    <name><![CDATA[rcmdnk]]></name>
    <email><![CDATA[rcmdnk@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[GitHub Actions使うWindows環境にリモートデスクトップアクセスする]]></title>
    <link href="https://rcmdnk.com/blog/2020/08/10/computer-windows-github/"/>
    <updated>2020-08-10T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2020/08/10/computer-windows-github</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/1533103852?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=1533103852&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/51XYnJFLlKL._SS200_.jpg" alt="Remote Desktop Services Windows Server 2012 R2: Design, Deployment and Management (Rds Pocket Consultant)" /></a>
</div>

<p><a href="https://rcmdnk.com/blog/2020/08/09/computer-windows-github/">前回</a>、
CI/CDサービスのAppVeyorを使う際に、実行するWindows環境にリモートデスクトップ
で入ってチェックすることをやってみましたが、
GitHub ActionsもWindows環境が使えるわけで、
そこにアクセスする方法について調べてみました。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#appveyorでのリモートデスクトップアクセス" id="markdown-toc-appveyorでのリモートデスクトップアクセス">AppVeyorでのリモートデスクトップアクセス</a></li>
  <li><a href="#github-actionsでのリモートデスクトップアクセス" id="markdown-toc-github-actionsでのリモートデスクトップアクセス">GitHub Actionsでのリモートデスクトップアクセス</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="appveyorでのリモートデスクトップアクセス">AppVeyorでのリモートデスクトップアクセス</h2>

<p>以下参照:</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2020/08/09/computer-windows-github/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20200809_win_120_90.jpg" width="120" height="90" alt="20200809_win_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2020/08/09/computer-windows-github/">AppVeyorで何故か失敗しているのをリモートデスクトップで入って確かめる</a></div></li></ul>

<h2 id="github-actionsでのリモートデスクトップアクセス">GitHub Actionsでのリモートデスクトップアクセス</h2>

<p>公式にAppVeyorの様な方法は出されて居ないようです。</p>

<p>動いているVM自体に直接アクセスすることは出来なそうですが、</p>

<p>以下の様に外部サービスを経由して接続している人がいました。</p>

<div class="github-widget" data-repo="nelsonjchen/reverse-rdp-windows-github-actions"></div>

<p>やっていることはリモートデスクトップのポートを外部の参照できるサーバーに飛ばして
そこにアクセスする、という方法。</p>

<p>ワークフローの例<a href="https://github.com/nelsonjchen/reverse-rdp-windows-github-actions/blob/master/.github/workflows/reverse_rdp.yml">reverse_rdp.yml</a>
を見るとわかりますが、
この際に
<a href="https://ngrok.com/">ngrok</a>
という、そういったポートを飛ばして公開できる様なサービスを使っています。</p>

<p>これだとこのポート飛ばしを行った状態で止まり続け、その先続けるためには
リモートデスクトップでアクセスしてngrokのプロセスをkillする、とかしかありません。</p>

<p>もしくは上のREADMEにあるようにジョブ自体をキャンセルしてしまうか。</p>

<p>なのでAppVeyorの様な使い方は出来ませんが、
途中で止まってしまって良くわからない、とか、
一通り終わったけど良くわからないエラーが起きている、とか言う場合には
使えそうです。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AppVeyorで何故か失敗しているのをリモートデスクトップで入って確かめる]]></title>
    <link href="https://rcmdnk.com/blog/2020/08/09/computer-windows-github/"/>
    <updated>2020-08-09T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2020/08/09/computer-windows-github</id>
    <content type="html"><![CDATA[<p>GitHubと連携できるCI/CDサービスでWindows環境も使える
<a href="https://www.appveyor.com/">AppVeyor</a>
でログだけ見ても良くわからないエラーが出たので
実行しているWindowsにリモートデスクトップでログインしてエラーを分析してみました。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#appveyor" id="markdown-toc-appveyor">AppVeyor</a></li>
  <li><a href="#起こった問題" id="markdown-toc-起こった問題">起こった問題</a></li>
  <li><a href="#リモートデスクトップの設定" id="markdown-toc-リモートデスクトップの設定">リモートデスクトップの設定</a></li>
  <li><a href="#今回の問題" id="markdown-toc-今回の問題">今回の問題</a></li>
  <li><a href="#解決法" id="markdown-toc-解決法">解決法</a></li>
  <li><a href="#github-actionsでのリモートデスクトップアクセス" id="markdown-toc-github-actionsでのリモートデスクトップアクセス">GitHub Actionsでのリモートデスクトップアクセス?</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="appveyor">AppVeyor</h2>

<p><a href="https://www.appveyor.com/">AppVeyor</a>
はGitHubと連携できるCI/CDサービスで
Windows環境を使えるサービスは少ないのでWindowsを使いたいときはよく使われてました。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2019/09/26/computer-windows-github/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20190926_appveyornewproject_120_90.jpg" width="120" height="90" alt="20190926_appveyornewproject_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2019/09/26/computer-windows-github/">AppVeyorでGitHubのリリースにビルドしたファイルを追加する</a></div></li></ul>

<p>(ただ最近はGitHub Actionsが出来てWindowsも使えるのであれかも。)</p>

<h2 id="起こった問題">起こった問題</h2>

<p><a href="https://github.com/rcmdnk/vim_ahk">vim_ahk</a>とかでテストやリリース用のバイナリを
コンパイルするのに使ってます。</p>

<div class="github-widget" data-repo="rcmdnk/vim_ahk"></div>

<p>最近新しいリリースを作ったらバイナリが作られず、ログを見てみると
コンパイルしているところで止まっっていました。</p>

<p>具体的には
<a href="https://github.com/AutoHotkey/Ahk2Exe">Ahk2Exe</a>
というアプリでAutoHotkeyのスクリプトをexeファイルに変換する部分で止まっていました。</p>

<p>止まった状態で最終的にタイムアウト(60分)経って失敗する、という感じ。</p>

<p>このアプリは細かいデバッグログを吐く様な設定が無いし、
手元のWinodwsだと何も問題なく動くのでどうもわからない状態でした。</p>

<p>そこで実際にコンパイルしている環境に入って見てみることに。</p>

<h2 id="リモートデスクトップの設定">リモートデスクトップの設定</h2>

<p>AppVeyorでは実行しているWindowsのVMにリモートデスクトップ(RDP)でアクセスすることが出来ます。</p>

<blockquote>
  <p><a href="https://www.appveyor.com/docs/how-to/rdp-to-build-worker/">Accessing Windows build worker via Remote Desktop (RDP)  AppVeyor</a></p>
</blockquote>

<p>上にある通りやればOK。</p>

<p>AppVeyorの設定ファイル<strong>.appveyor.yml</strong>で、
<code>init</code>のセクションに</p>

<pre><code>init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
</code></pre>

<p>と、リモートデスクトップを有効にする設定を入れます。
これをするとこれ以降の部分でスクリプトを実行している間リモートデスクトップでログイン出来るようになります。</p>

<p>これを設定して実行すると、AppVeyorのウェブから見えるログに、</p>

<pre><code>iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
Remote Desktop connection details:
  Server: XX.XXX.XXX.XXX:XXXXX
  Username: appveyor
  Password: XXXXXXXXXXXXXXX
Build paused. To resume it, open a RDP session to delete 'Delete me to continue build.txt' file on Desktop.
</code></pre>

<p>といった表示の状態でAppVeyorのページで見れるログの表示が止まる様になります。</p>

<p>ここにログインに必要なサーバー、ユーザー名(必ず<code>appveyor</code>)、パスワードの情報が表示されます。</p>

<p>この状態でリモートデスクトップを立ち上げて上の通りに接続してあげれば
実行している環境にログイン出来ます。</p>

<p>パスワードは何も設定してないと毎回自動的に決めて上の様に表示してくれますが、
そのプロジェクトの<strong>Settings</strong><i class="fa fa-arrow-right"></i><strong>Environment</strong>
から<code>APPVEYOR_RDP_PASSWORD</code>という値を決めておくと上の<code>Password</code>表示がなくなり、
<code>APPVEYOR_RDP_PASSWORD</code>がパスワードになります。</p>

<p>または<strong>.appveyor.yml</strong>の<code>environment</code>セクションで<code>APPVEYOR_RDP_PASSWORD</code>の値を
設定することでも同様になります。</p>

<pre><code>environment:
  - APPVEYOR_RDP_PASSWORD: XXXXXXXXXXXXX
</code></pre>

<p>ログインしたらWindowsなのでコマンドプロンプトを立ち上げて実行スクリプトを手で
実行してみたり色々試すことが出来ます。</p>

<p>これだと実行スクリプトが一通り終わると立ち上がったVMも終了してしまい、
すぐに終わるスクリプトだとログインする暇も無いですが、
すべて終わった状態で調べたい場合には
代わりに終了時に以下を実行する様に設定:</p>

<pre><code>on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
</code></pre>

<p><code>$blockRdp = $true;</code>加えることでこれを実行した箇所でスクリプト自体が止まる様になり、
その状態でログイン出来るようになります。</p>

<p>これは別に<code>on_finish</code>でなくても良くて、</p>

<pre><code>build_script:
  - cmd echo test1
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - cmd echo test2
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - ...
</code></pre>

<p>みたいな感じで止めたいところに複数置くことが出来ます。</p>

<p><code>$blockRdp = $true;</code>な状態でログインするとデスクトップに
<strong>Delete me to continue build.txt</strong>というファイルがあります。</p>

<p><img src="https://rcmdnk.com/images/post/20200809_rdp.jpg" alt="20200809_rdp" class="pic" /></p>

<p>このファイルを消すとブロック状態が終わってスクリプトが先に進んでいきます。</p>

<p>その後に止まるところがなければ全部終了してVMも落ちるので
接続したままでもそのうちサーバー側がなくなって切断します。</p>

<p><code>init</code>セクションなどで
<code>$blockRdp = $true</code>なしでログインした場合にはスクリプトが終わるまでログイン出来る状態になっています。</p>

<h2 id="今回の問題">今回の問題</h2>

<p>さて、上の様にしてログインしてみると</p>

<p><img src="https://rcmdnk.com/images/post/20200809_ahk2exe.jpg" alt="20200809_ahk2exe" class="pic" /></p>

<p>みたいなのが出てました。</p>

<p>この</p>

<pre><code>Error: Unable to copy AutoHotkeySC binary file to destination.
</code></pre>

<p>でググってみるとこのバイナリが別プロセスで実行中だったりすでにこのファイルがあったり、
だとか言う話が出てきましたが、
調べてみると<strong>C:\Users\appveyor\AppData\Local\Temp**には</strong>~Ahk2Exe~build**というフォルダすらない状態。</p>

<p>で、どうやら単に<strong>C:\Users\appveyor\AppData\Local\Temp~Ahk2Exe~build\vim_ahk~exe~xxxxxxx.tmp</strong>
というファイルが書き込めない、という状態らしい。</p>

<p>試しに<strong>C:\Users\appveyor\AppData\Local\Temp~Ahk2Exe~build</strong>というフォルダを手動で作ってやると
コマンドが成功しました。</p>

<p>パーミッションか何かおかしいのかな、と思ってちょっと調べてみます。</p>

<pre><code>C:\Users\appveyor&gt;dir /q C:\Users\appveyor\AppData\Local\Temp
 Volume in drive C is Windows
 Volume Serial Number is D4AB-4044

 Directory of C:\Users\appveyor\AppData\Local\Temp

08/09/2020  08:54 AM    &lt;DIR&gt;          APPVYR-WIN\appveyor    .
08/09/2020  08:54 AM    &lt;DIR&gt;          APPVYR-WIN\appveyor    ..
08/09/2020  08:54 AM    &lt;DIR&gt;          BUILTIN\Administrators 1
               0 File(s)              0 bytes
               3 Dir(s)  44,071,612,416 bytes free

C:\Users\appveyor&gt;
</code></pre>

<p>ということで、<strong>Temp</strong>の下に<strong>1</strong>という管理者が作ったものはありますが、
<strong>Temp</strong>自体は<code>appveyor</code>ユーザーのもので特におかしくない模様。</p>

<p>実際、上にも書いてますが、フォルダから手動でも作れましたし、コマンドで、</p>

<pre><code>C:\Users\appveyor&gt;mkdir "C:\Users\appveyor\AppData\Local\Temp\~Ahk2Exe~build"
</code></pre>

<p>としても作れました。なのでパーミッションの問題、
というよりはフォルダがない状態でその中に書き込もうとしてるの問題という感じ。</p>

<p>ちょっと色々やってみようと、</p>

<pre><code>SET AHKPath=C:\Program Files\AutoHotkey
"%AHKPath%\compiler\ahk2exe.exe" /in vim.ahk /out build/vim_ahk.exe
</code></pre>

<p>というコマンドを</p>

<pre><code>SET AHKPath=C:\Program Files\AutoHotkey
"%AHKPath%\compiler\ahk2exe.exe" /in vim.ahk /out build/vim_ahk.exe /bin "%AHKPath%\compiler\AutoHotkeySC.bin
</code></pre>

<p>としてみても特に変わらず(相変わらずAutoHotkeySCをコピーしようとする)。</p>

<p><strong>ahk2exe.exe</strong>はそのまま実行するとGUIで使えるので、
GUIを立ち上げて上の入出力ファイルを設定してConvertしてみると
<strong>C:\Users\appveyor\AppData\Local\Temp~Ahk2Exe~build</strong>
がなくても成功します。</p>

<p>どうやらコマンドとして実行するときだけ一時ファイルを使う?</p>

<p>試しにローカル環境で<strong>Temp</strong>にファイルが出来るかどうか見てみると、</p>

<pre><code>**C:\Users\user\AppData\Local\Temp\~temp507510843.tmp**
</code></pre>

<p>みたいに<strong>Temp</strong>直下に一時ファイルが出来ていました。
GUIでやると何も出来ず。</p>

<p>手元のWindowsはWindows 10、AppVeyorはWindows Server 2012 R2 Datacenter。
AutoHotkeyは手元が
1.1.31.00、
Appveyorでは最新の1.1.33.2。</p>

<p>まず、Windowsの違いで<strong>%TEMP%</strong>か<strong>%TMP%</strong>の値が違うのか、と思って<code>cmd: echo %TEMP%</code>とかで見てみると
とちらも
<strong>C:\Users\appveyor\AppData\Local\Temp</strong>
で特に変わらず。</p>

<p>AutoHotkeyのバージョンも違いますが、関係ないかな、と思いながら手元のAutoHotkeyをアップデートして試してみると、
同じエラーが出ました。。。</p>

<p>どうやらAutoHotkeyのバージョンのせいらしい。</p>

<p>AutoHotkeyの現在のレポジトリは以下。</p>

<div class="github-widget" data-repo="Lexikos/AutoHotkey_L"></div>

<p>で、ちゃんと理解してないですが、おそらく上のメインのレポジトリで作られるsetupファイルで、
実際にインストールするときに入れられるAhk2Exeは以下。</p>

<div class="github-widget" data-repo="AutoHotkey/Ahk2Exe"></div>

<p>これらを見ても上の様な問題がIssueになったりはしてません。</p>

<p><a href="https://www.autohotkey.com/boards/viewtopic.php?t=65095">Upcoming Ahk2Exe Changes (2019) - AutoHotkey Community</a></p>

<p>この辺のところを見ても特になし。</p>

<p>調べてみると1.1.32.00では問題なく、1.1.33.00から問題が起こっている模様。
1.1.33.00が今年の6月に作られたもの。</p>

<p>問題があればIssueとかになってても良さそうなものですが、
そもそもAhk2Exeを使ってバイナリ化する、ということがそれほどないかもしれませんし、
GUIを使う人はあれ、コマンドとして実行する、というのが稀すぎて気づかれてないだけかも?</p>

<p>もうちょっと調べてIssueとかに投げてみます。</p>

<h2 id="解決法">解決法</h2>

<p>上にも書いたとおりフォルダが無いのが問題なので、コンパイルを実行する前に</p>

<pre><code>- cmd: mkdir "C:\Users\appveyor\AppData\Local\Temp\~Ahk2Exe~build"
</code></pre>

<p>を付け加えることで動く様にはなりました。</p>

<p>ただ、Ahk2Exe自体には問題がありそうなのでちょっと見てみる必要がありそう。</p>

<h2 id="github-actionsでのリモートデスクトップアクセス">GitHub Actionsでのリモートデスクトップアクセス?</h2>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/1533103852" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/51XYnJFLlKL._SS90_CR0,0,120,90_.jpg" alt="Remote Desktop Services Windows Server 2012 R2: Design, Deployment and Management (Rds Pocket Consultant)" /></a>
</div>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2020/08/10/computer-windows-github/">GitHub Actions使うWindows環境にリモートデスクトップアクセスする</a></div></li></ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NVIDIA GeForceからディスプレイへの音声出力でのトラブル]]></title>
    <link href="https://rcmdnk.com/blog/2020/06/21/computer-windows/"/>
    <updated>2020-06-21T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2020/06/21/computer-windows</id>
    <content type="html"><![CDATA[<p>デスクトップPCからの音声出力をGPUから出力しているディスプレイから
行っている状態でちょっと困ったことになったのでそれについて。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#環境" id="markdown-toc-環境">環境</a></li>
  <li><a href="#問題発生" id="markdown-toc-問題発生">問題発生</a></li>
  <li><a href="#解決策1" id="markdown-toc-解決策1">解決策1</a></li>
  <li><a href="#解決策2" id="markdown-toc-解決策2">解決策2</a></li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="環境">環境</h2>

<p>PCはNVIDIA GeForce RTX 2070 superを積んだWindowsマシン。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07KSNSFLB?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07KSNSFLB&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/718Rm465mpL._SS90_CR0,0,120,90_.jpg" alt="AOC ゲーミング モニター C32G1/11 (31.5インチ/144Hz/1ms/VA 曲面パネル/HDMI×2 DP×1)" /></a>
</div></div><a class="click_box_link" href="https://rcmdnk.com/blog/2019/09/20/computer-windows/">増税前にWindows用PC購入: FRONTIERでFRGAH370/WSB/NTK GAを購入</a></div></li></ul>

<p>普段はここからDisplayPort (to DisplayPort)でディスプレイに画像を出力。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07KSNSFLB?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07KSNSFLB&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/718Rm465mpL._SS90_CR0,0,120,90_.jpg" alt="AOC ゲーミング モニター C32G1/11 (31.5インチ/144Hz/1ms/VA 曲面パネル/HDMI×2 DP×1)" /></a>
</div></div><a class="click_box_link" href="https://rcmdnk.com/blog/2019/09/21/computer-windows/">AOC C32G1/11 144Hz 31.5インチのVA局面パネルディスプレイを購入</a></div></li></ul>

<p>ディスプレイにはスピーカーは付いてませんが、イヤフォンジャックがついていて
そこにスピーカーを付けて音を出しています。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2019/10/26/computer-windows/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20191026_speaker2_120_90.jpg" width="120" height="90" alt="20191026_speaker2_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2019/10/26/computer-windows/">ダイソーの300円スピーカー</a></div></li></ul>

<p>こんな感じでDisplayPortやらHDMIのデジタル出力だと画像と同時に音声も送れます。</p>

<h2 id="問題発生">問題発生</h2>

<p>問題が発生したのは別のディスプレイにHDMI (to HDMI)で画像を送ろうと接続した時。</p>

<p>この時、音も新しくつないだディスプレイ(こちらはスピーカー付き)の方から出る様になりました。</p>

<p>その後、HDMIを外すとDisplayPortでつないだ方からは音が出ない状態で、
サウンド設定の辺りを見てみてもそれが見当たりません。</p>

<p><img src="https://rcmdnk.com/images/post/20200621_sound1.png" alt="20200621_sound1.png" class="pic" /></p>

<p>HDMI接続前は<strong>32G1WG4</strong>というディスプレイのものがありそれが既定になっていましたが、
HDMIを接続するとそれが消え、HDMIに繋がれた<strong>Capsule II</strong>というものが既定になります。</p>

<p>その後、HDMIを外すと、当然<strong>Capsule II</strong>は利用不可になるわけですが、
<strong>32G1WG4</strong>は復帰しません。</p>

<p>何故か他に2つDisplayPortはあるのですが、これは恐らくつないでない出力のもの。</p>

<p>治すには一旦スリープに落とすなり再起動する必要がありました。
DisplayPortを繋げ直すと治ることもありましたが治らないことも。</p>

<p>これだと気軽に別ディスプレイを繋げられず困った状態に。</p>

<h2 id="解決策1">解決策1</h2>

<p>NVIDIAのGPUを使っていると、NVIDIAコントロールパネル、というものがインストールされていると思います。</p>

<p>タスクバー上にある緑のアイコンをクリックするかコントロールパネルの中から探して立ち上げます。</p>

<p><img src="https://rcmdnk.com/images/post/20200621_nvidiacp3.jpg" alt="20200621_nvidiacp3.jpg" class="pic" />
<img src="https://rcmdnk.com/images/post/20200621_nvidiacp4.png" alt="20200621_nvidiacp4.png" class="pic" /></p>

<p>この中でデジタル・オーディオ設定、というのを開くと、
各ポートに繋がっているディスプレイ毎にオーディオが選べる様になっています。</p>

<p><img src="https://rcmdnk.com/images/post/20200621_nvidiacp1.png" alt="20200621_nvidiacp1.png" class="pic" /></p>

<p>GeForce RTX 2070 superは3つのDisplayPort出力と1つのHDMI出力があります。</p>

<p>PCの背面に(設置の向きによりますが)上の画像の通り、右からDisplayPort(1)、HDMI、DisplayPort(2)、DisplayPort(3)と配置されています。
(HDMIが真ん中にぽつんとあるのは設計上の意味があるのでしょうか?)</p>

<p>DisplayPort(3)にAOC 32G1WG4がありますが、これが普段使っているディスプレイ。
(3)を使っていたのは一番左にあり、ディスプレイが(PCの後ろから見て)左側にあるため。</p>

<p>もう一つのHDMIにつながってるCapsule IIが臨時的に付けてるもの。</p>

<p>モバイルプロジェクターです(HDMI入力あり、スピーカー機能もついてる)。</p>

<div class="amazon-box">
  <div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07QBXMY2Z?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07QBXMY2Z&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/415l0kv0gGL._SS200_.jpg" alt="Anker Nebula Capsule II" /></a>
</div>

  <div class="amazon-title">
    <a href="//www.amazon.co.jp/gp/product/B07QBXMY2Z?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07QBXMY2Z&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Anker Nebula Capsule II</a>
  </div>
  <div class="amazon-txt">
    <span class="amazon-link"><a href="//www.amazon.co.jp/gp/product/B07QBXMY2Z?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07QBXMY2Z&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Amazonで見る</a></span>
    <span class="rakuten-link"><a href="//hb.afl.rakuten.co.jp/hgc/111f634c.5fb25e94.111f634d.1a56ae16/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FAnker+Nebula+Capsule+II%2F&amp;m=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FAnker+Nebula+Capsule+II%2F&amp;scid=af_url_txt&amp;link_type=text&amp;ut=eyJwYWdlIjoidXJsIiwidHlwZSI6InRlc3QiLCJjb2wiOjB9" rel="nofollow" target="_blank">楽天市場で見る</a></span>
  </div>
</div>

<p>HDMIの方はドロップダウンボックスみたいになっていますが、
ここで、<strong>オーディオをオフにする</strong>というのを選択出来る様になっています。
(何故かDisplayPortの方はその選択が出来ない。。。)</p>

<p>ここで、HDMIをつないだ状態で一度この設定を<strong>オーディオをオフにする</strong>にします。
(つないでないと選択も出来ないので一度はつなぐ必要あり。)</p>

<p><img src="https://rcmdnk.com/images/post/20200621_nvidiacp2.png" alt="20200621_nvidiacp2.png" class="pic" /></p>

<p>ここでオフにしてしまうと、DisplayPortから出してる32G1WG4の方がサウンド設定にはない状態のため
音が出なくなりますが、ここは一旦諦めてHDMIも外してスリープに。</p>

<p>再度開始するとサウンド設定に32G1WG4が現れ、ディスプレイから音が出るようになっています。</p>

<p>このままHDMIを繋いでみると、32G1WG4のディスプレイ側から音が出続け、HDMIを外しても大丈夫な状態に。</p>

<p>HDMIの<strong>Capsule II</strong>側は選択出来ない状態になりますが、仕方ないか、という状態。</p>

<p>とりあえずこれでもいいか、と思ってましたが、ちょっと別のことを試してみることに。</p>

<h2 id="解決策2">解決策2</h2>

<p>最初はDisplayPort(3)に繋いでいたわけですが、音声出力が優先されるのは上のものでは?
ということでDisplayPort(1)に繋いでみました。</p>

<p>HDMIの方は一度<strong>Capsule II</strong>に関しても有効にしてあります。</p>

<p>その状態でHDMIをつなぐと、音は32G1WG4のディスプレイの方から出続けました。</p>

<p>この状態だとHDMIの方の<strong>Capsule II</strong>も選択出来る状態で切り替えが可能です。</p>

<p>その後、HDMIを外してみてもちゃんとディスプレイ側から音が出続けます。</p>

<p>試しに、HDMIを接続した状態で、<strong>Capsule II</strong>の方を既定の出力にしてみると、
HDMIをつなぐとCapsule IIから、外すと32G1WG4のディスプレイの方から出る様になり、
期待通りの動作になりました。</p>

<p>もう一つDisplayPort(2)がありますが、こちらに繋いでも同じ状態。
優先度的にも(1)と同じく、何もしなければHDMIよりもDisplayPort(2)の方が優先される様でした。</p>

<p>なのでNVIDIAコントロールパネルの表示順、というわけではなく、DisplayPort(1)、(2)が優先、
その次HDMIで最後がDisplayPort(3)?</p>

<p>これでDisplayPort(3)とかにも繋げてみると今度はうまくいきそう?な感じになってました。</p>

<p>この状態でサウンド設定を見てみると、繋いでないものも<strong>32G1WG4</strong>が残っている状態になっています。</p>

<p><img src="https://rcmdnk.com/images/post/20200621_nvidiacp5.jpg" alt="20200621_nvidiacp5.jpg" class="pic" /></p>

<p>ただ、DisplayPort(3)はやはり何かバグってる感じで、
もう一度DisplayPort(3)につなぎ、HDMIを繋いで<strong>Capsule II</strong>から音を出すようにした所、
DisplayPort(3)に関する<strong>32G1WG4</strong>がサウンド設定から消え、
復帰しなくなりました。(一度スリープで復帰)</p>

<p>なのでとりあえずDisplayPort(3)は無視してDisplayPort(2)に繋いだ状態にすることで
問題なく使えるようになりました。</p>

<h2 id="まとめ">まとめ</h2>

<p>NVIDIA GeForce RTX 2070 superの一番左の出力、DisplayPort(3)は問題がある?
様で、HDMIに別のディスプレイを繋ぐことでDisplayPort(3)から音の出力が出来なくなります。</p>

<p>ハードウェア的な問題、というよりはソフトウェア的な問題な感じですが、
この個体が何か壊れているのか、NVIDIA GeForce RTX 2070 superの問題なのか、
もしくはGeForce系ではよくあることなのか?</p>

<p>ざっと同じ様な症状を探してみた所では同じ問題を抱えてる人は見つかりませんでした。
なので個体の問題かもしれませんが、
多分問題があっても、同じ様な状態を作ることは余りないでしょうし、
特にDisplayPort(1)や(2)は問題ないのでなかなか当たらなそう。</p>

<p>個体の問題なら保証でなんとかならないか、とも思いますが、
そうとも限らないし、
とりあえずDisplayPort(2)に繋いでおけば問題ないので、しばらくはそれで。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WSL2は場合によってはWSL1の10倍も速い!?]]></title>
    <link href="https://rcmdnk.com/blog/2020/06/02/computer-windows/"/>
    <updated>2020-06-02T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2020/06/02/computer-windows</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07F1PWZV6?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07F1PWZV6&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/51prjN5W9KL._SS200_.jpg" alt="【WSLオフィシャル販売】Groundswell メンズ Tシャツ/Groundswell Mens Tee" /></a>
</div>

<p>WindowsのWindows Subsystem for Linux (WSL)のバージョン2 (WSL2)が
制しきりシースされ、最新のWindowsアップデートを行うことで
使える様になりました。</p>

<p>ということでちょっと使ってみましたが、プロセスによってはかなり速くなってそうです。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#windows-subysytem-for-linux-wsl" id="markdown-toc-windows-subysytem-for-linux-wsl">Windows Subysytem for Linux (WSL)</a></li>
  <li><a href="#wsl2のインストール" id="markdown-toc-wsl2のインストール">WSL2のインストール</a></li>
  <li><a href="#パフォーマンスチェック" id="markdown-toc-パフォーマンスチェック">パフォーマンスチェック</a>    <ul>
      <li><a href="#ファイルの生成削除" id="markdown-toc-ファイルの生成削除">ファイルの生成削除</a></li>
      <li><a href="#ddでのチェック" id="markdown-toc-ddでのチェック">ddでのチェック</a></li>
      <li><a href="#サブシェルチェック" id="markdown-toc-サブシェルチェック">サブシェルチェック</a></li>
      <li><a href="#サブシェルチェック-2" id="markdown-toc-サブシェルチェック-2">サブシェルチェック 2</a></li>
      <li><a href="#git-clone" id="markdown-toc-git-clone">git clone</a></li>
    </ul>
  </li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="windows-subysytem-for-linux-wsl">Windows Subysytem for Linux (WSL)</h2>

<p>Windows Subysytem for Linux (WSL)はWindows上でLinuxの実行環境を作るシステムです。</p>

<p>以前もサードパーティーなCygwinの様なものはありましたが、
Windowsネイティブで、というところで期待されています。</p>

<p>WSL 1では独自のサブシステムを作ってLinuxの実行環境を作っていました。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2016/06/05/computer-windows-ubuntu-bash/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20160605_bashonubuntuonwindows_120_90.jpg" width="120" height="90" alt="20160605_bashonubuntuonwindows_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2016/06/05/computer-windows-ubuntu-bash/">Windowsに採用されたBash (Ubuntu)を試してみる</a></div></li></ul>

<p>WSL 2では仮想マシンでLinuxカーネルを動かしてホントのLinux環境になります。</p>

<p>これによってWSL 1では互換性がなかったLinuxのソフトウェアなども問題なく動かせる様になります。</p>

<p>Windowsでの仮想マシンの利用、というのは以前もありましたが、
WSLではMacとかでターミナルを立ち上げる感覚でシステムごと立ち上げる事ができ
今まで使っていた仮想マシン環境とはかなり感覚的に違うものになっています。</p>

<h2 id="wsl2のインストール">WSL2のインストール</h2>

<p>まずはWindowsをバージョン19041以上にする必要があります。</p>

<p>これはつい先日配信が開始された
May 2020 Updateを入れると入ります。</p>

<p>ただし、今回はその前にInsider Programで入れて19041以上にしてやっています。
(ちょうどWSL2試そうと思ったタイミングで正式リリースが来てしまった。。。)</p>

<p>May 2020 Updateがまだ来て無くてInsider Programを入れたくない場合は
以下に従ってMay 2020 Updateを入手:</p>

<blockquote>
  <p><a href="https://support.microsoft.com/ja-jp/help/4028685/windows-10-get-the-update">Windows 10 May 2020 Update を入手する</a></p>
</blockquote>

<p>ただ、結構問題が起きてる様なので、無理に急いで上げるのは避けたほうが良いかもしれません。</p>

<blockquote>
  <p><a href="https://pc.watch.impress.co.jp/docs/news/1255346.html">「Windows 10 May 2020 Update」でブルースクリーン発生やBluetooth未接続、一部アプリでIME不具合 - PC Watch</a></p>
</blockquote>

<p>WSL2のインストールは以下に従って。</p>

<blockquote>
  <p><a href="https://docs.microsoft.com/ja-jp/windows/wsl/install-win10">Windows Subsystem for Linux (WSL) を Windows 10 にインストールする Microsoft Docs</a></p>
</blockquote>

<p>WSLが入ってない場合はまずPowerShellを管理者権限で起動して(Windowsのスタートボタンを右クリック、から)</p>

<pre><code>PS C:\WINDOWS\system32&gt; dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
</code></pre>

<p>もう一つ、”仮想マシン プラットフォーム” のオプション コンポーネントを有効にするために</p>

<pre><code>PS C:\WINDOWS\system32&gt; dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre>

<p>を実行して再起動。</p>

<p>再起動後、WSL2をデフォルトにするため、管理者権限で立ち上げたPowerShellから</p>

<pre><code>PS C:\WINDOWS\system32&gt; wsl --set-default-version 2
</code></pre>

<p>を実行します。これで今後入れるLinuxディストリビューションがWSL2として動きます。</p>

<p>すでにUbuntuすでにとかを入れている場合、更新プログラムパッケージを使って更新する必要があります。</p>

<blockquote>
  <p><a href="https://docs.microsoft.com/ja-jp/windows/wsl/wsl2-kernel">WSL 2 Linux カーネルの更新  Microsoft Docs</a></p>
</blockquote>

<p>から更新プログラムパッケージをダウンロードして実行します。</p>

<p>実行後、PowerShellを管理者権限で立ち上げて
インストール済のLinuxディストリビューションをWSL2にします。</p>

<pre><code>PS C:\WINDOWS\system32&gt; wsl -l
Linux 用 Windows サブシステム ディストリビューション:
Ubuntu (既定)
PS C:\WINDOWS\system32&gt; wsl --list --verbose
  NAME      STATE           VERSION
* Ubuntu    Running         1
</code></pre>

<p>現在はUbuntuがWSL1で入っています。
これをWSL2に変更。</p>

<p>上で<code>Running</code>になってますが、WSLを立ち上げていても、以下のコマンドを実行すると
強制的に終了するので、
WSL側の作業はちゃんと終了してからやってください。</p>

<pre><code>PS C:\WINDOWS\system32&gt; wsl --set-version Ubuntu 2
変換中です。この処理には数分かかることがあります...
WSL 2 との主な違いについては、https://aka.ms/wsl2 を参照してください
変換が完了しました。
PS C:\WINDOWS\system32&gt;
PS C:\WINDOWS\system32&gt; wsl -l -v
  NAME      STATE           VERSION
* Ubuntu    Stopped         2
PS C:\WINDOWS\system32&gt;
</code></pre>

<p>ちなみに恐らくWSLの中で使っているファイルの数とかに関係あるとは思うんですが、
今回上のコマンドをやってみた所、30分近くかかりました。</p>

<p>さらに実行中に他のことしてたら、
多分ファイルのIOが激しいからだと思いますが、
時々不安定になることがあって作業に支障をきたす位でした。</p>

<p>なのでやるなら夜中とか使わない時にやった方が良いと思います。</p>

<p>もし、更新プログラムパッケージを適用してないと</p>

<pre><code>PS C:\WINDOWS\system32&gt; wsl --set-version Ubuntu 2
変換中です。この処理には数分かかることがあります...
WSL 2 を実行するには、カーネル コンポーネントの更新が必要です。詳細については https://aka.ms/wsl2kernel を参照してください
PS C:\WINDOWS\system32&gt;
</code></pre>

<p>的なメッセージが出ます。</p>

<h2 id="パフォーマンスチェック">パフォーマンスチェック</h2>

<p>WSL 2ではファイルIOなどかなり改善されている、ということだったのでちょっとテストしてみました。</p>

<p>テスト環境は</p>

<ul>
  <li>WSLのOS: 18.04.2 LTS (Bionic Beaver)</li>
  <li>CPU: Intel(R) Core(TM) i7-9700K CPU @ 3.60GHz</li>
  <li>Memory: 16696168 kB (/proc/meminfo)</li>
</ul>

<h3 id="ファイルの生成削除">ファイルの生成削除</h3>

<p>以下のコマンドを実行</p>

<pre><code>$ x=$(seq 1 1000)
$ time for i in $x;do rm -f file &amp;&amp; touch file;done
</code></pre>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real  0m10.056s
  user  0m0.406s
  sys 0m7.922s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real  0m0.949s
  user  0m0.281s
  sys 0m0.226s
</code></pre>
  </li>
</ul>

<p>WSL 2の方が10倍位速くなっています。</p>

<h3 id="ddでのチェック">ddでのチェック</h3>

<p>以下を実行</p>

<pre><code>$ for i in $(seq 1 10);do sleep 1;dd if=/dev/zero of=/tmp/write$1.tmp ibs=1M obs=1M count=1024 2&gt;&amp;1|grep -v "^1024+0";done
</code></pre>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.30206 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.295579 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.300499 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.295048 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.298456 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.298082 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.297875 s, 3.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.305186 s, 3.5 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 1.39612 s, 769 MB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.297403 s, 3.6 GB/s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.640851 s, 1.7 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.660463 s, 1.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.648255 s, 1.7 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.656519 s, 1.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.65121 s, 1.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.651856 s, 1.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.665299 s, 1.6 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.723154 s, 1.5 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.707145 s, 1.5 GB/s
  1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.711927 s, 1.5 GB/s
</code></pre>
  </li>
</ul>

<p>これはなぜかWSL 1の方が倍くらい速い。</p>

<p>何度かチェックしてみてるんですが変わりません。</p>

<p>上のチェックで大きくWSL 2の方が速かったのにちょっとこの結果の意味はよくわかってません。</p>

<h3 id="サブシェルチェック">サブシェルチェック</h3>

<p>Cygwinとかを使ってて異常に遅いな、と感じるのはサブシェルを立ち上げる様なプロセスが
走っているときでした。</p>

<p>システム上、別のプロセスを立ち上げる様なことが通常のLinuxとかに比べて格段に遅くなるようです。</p>

<p>同様にWSLを使ってみた時もサブシェルを立ち上げると遅くなるな、と感じてました。</p>

<p>ということでそのチェック。</p>

<p>以下を実行</p>

<pre><code>$ x=$(seq 1 10000)
$ j=0; time for i in $x;do j=$(expr $j + 1);done
</code></pre>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real  0m49.069s
  user  0m2.406s
  sys 0m37.063s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real  0m5.699s
  user  0m0.855s
  sys 0m1.192s
</code></pre>
  </li>
</ul>

<p>ということでこれもWSL 2の方が10倍位速くなっています。</p>

<p>同じ作業をサブシェルを作らずに行うには以下の様なコマンドが使えます。</p>

<pre><code>$ x=$(seq 1 10000)
$ j=0; time for i in $x;do ((j++));done
</code></pre>

<p>これだと</p>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real  0m0.043s
  user  0m0.016s
  sys 0m0.031s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real  0m0.014s
  user  0m0.014s
  sys 0m0.000s
</code></pre>
  </li>
</ul>

<p>WSL 1でも上のWSL 2より格段に速くなっています。速すぎて正確さに欠けますが、
ここでもWSL 2の方が速くはなってます。</p>

<h3 id="サブシェルチェック-2">サブシェルチェック 2</h3>

<p>別のコマンドでチェック</p>

<pre><code>$ x=$(seq 1 1000)
$ time for i in $x;do a="XXXabcXXX";a=$(echo $a|sed "s/abc/def/");done
</code></pre>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real  0m8.042s
  user  0m0.344s
  sys 0m6.344s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real  0m1.004s
  user  0m1.158s
  sys 0m0.137s
</code></pre>
  </li>
</ul>

<p>これも約10倍くらいの差。</p>

<p>同様のことをサブシェルなしだと</p>

<pre><code>$ x=$(seq 1 1000)
$ time for i in $x;do a=XXXabcXXX;a=${a/abc/def};done
</code></pre>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real  0m0.006s
  user  0m0.016s
  sys 0m0.000s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real  0m0.003s
  user  0m0.001s
  sys 0m0.002s
</code></pre>
  </li>
</ul>

<p>ということで、WSL 2の方が速い、ですが、こういったことは通常でも
なるべくサブシェルを使わずにやった方が圧倒的に速くなります。</p>

<h3 id="git-clone">git clone</h3>

<p>ファイルの書き込みを多く行う<code>git clone</code>とかが速くなった、という話を見たのでチェック。</p>

<pre><code>$ repo=git@github.com:rcmdnk/rcmdnk.github.io.git
$ (time git clone $repo &gt;&amp;/dev/null) 2&gt;&amp;1|tr '\n' ' '|tr '\t' ' '
</code></pre>

<p>自分のレポジトリで大きそうなもの(このブログのレポジトリ)でチェック。
サイズはclone後に337MBほどでした。</p>

<ul>
  <li>
    <p>WSL 1</p>

    <pre><code>  real 0m47.073s user 0m3.891s sys 0m3.453s
  real 0m26.106s user 0m2.859s sys 0m2.766s
  real 0m27.844s user 0m2.828s sys 0m3.000s
  real 0m26.955s user 0m2.844s sys 0m3.078s
  real 0m38.123s user 0m3.156s sys 0m2.922s
  real 1m0.090s user 0m3.969s sys 0m3.750s
  real 0m43.652s user 0m3.313s sys 0m3.297s
  real 0m30.926s user 0m2.891s sys 0m3.297s
  real 0m25.048s user 0m3.156s sys 0m2.797s
  real 0m23.092s user 0m2.813s sys 0m2.391s
</code></pre>
  </li>
  <li>
    <p>WSL 2</p>

    <pre><code>  real 0m26.673s user 0m3.694s sys 0m1.374s
  real 0m26.953s user 0m4.328s sys 0m1.648s
  real 0m33.887s user 0m4.457s sys 0m2.148s
  real 0m53.725s user 0m5.659s sys 0m2.902s
  real 1m9.217s user 0m5.338s sys 0m2.212s
  real 0m30.451s user 0m3.649s sys 0m1.246s
  real 0m38.896s user 0m4.234s sys 0m1.693s
  real 1m0.555s user 0m4.976s sys 0m2.448s
  real 0m18.706s user 0m4.446s sys 0m1.277s
  real 0m17.233s user 0m3.457s sys 0m0.910s
</code></pre>
  </li>
</ul>

<p>ムラがありますが全体的にはWSL 2の方が速い。
ただ恐らくネットワーク的なムラが原因なのかな、という感じもあるので余り
意味のある結果ではないかもしれません。</p>

<h2 id="まとめ">まとめ</h2>

<p>ということで、軽くパフォーマンスを見てみた所、
差があるところで10倍くらいWSL 2の方が速くなっていました。</p>

<p>WSL 2が使える環境であれば特にデメリットも無いと思うのでWSL 2に上げた方が良いと思います。</p>

<p>すでに使ってるものを2に上げるのはちょっと時間がかかるので時間に余裕がある時にやったほうが良いですが。</p>

<p>ちょっと性能が低いPCだとWSL 1だと立ち上げるだけでも結構時間がかかって余り使いたくないものだったかもしれませんが、
WSL 2なら使えるかもしれません。</p>

<p>その他で気づいたことはまだ無いですが、今は結構使ってるのでまた
なにか気づいたら書いていこうと思います。</p>

<p>ddの結果は謎。</p>

<p>ちなみにターミナルとしてはWindows Terminalを使おうと思ってたんですが
ちょっと使いづらいところがあったので今はwslttyを使ってます。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2020/05/31/computer-ubuntu-bash/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20200531_profiles_120_90.png" width="120" height="90" alt="20200531_profiles_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2020/05/31/computer-ubuntu-bash/">Windows Terminalを試す</a></div></li></ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Windows Package Manager?]]></title>
    <link href="https://rcmdnk.com/blog/2020/05/23/computer-windows-chocolatey-packagemanagement-powershell/"/>
    <updated>2020-05-23T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2020/05/23/computer-windows-chocolatey-packagemanagement-powershell</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B013I9SWMC?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B013I9SWMC&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/51m%2BteN-t7L._SS200_.jpg" alt="Microsoft Windows 10 Home April 2018 Update適用 32bit/64bit 日本語版【最新】|オンラインコード版" /></a>
</div>

<p>Windowsの新しいパッケージマネージャー、
<a href="https://devblogs.microsoft.com/commandline/windows-package-manager-preview/">Windows Package Manager</a>
というものが開発中でプレビュー版として配布されるようになったそうです。</p>

<p>以前PackageManagementというものがあったはずなんですが、どうなったのか。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#windows-package-manager" id="markdown-toc-windows-package-manager">Windows Package Manager</a></li>
  <li><a href="#packagemanagement" id="markdown-toc-packagemanagement">PackageManagement…?</a></li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="windows-package-manager">Windows Package Manager</h2>

<p>Windows Package ManagerはOSSになっていてGitHubでソースも見ることが出来ます。</p>

<div class="github-widget" data-repo="microsoft/winget-cli"></div>
<div class="github-widget" data-repo="microsoft/winget-pkgs"></div>

<p><a href="https://docs.microsoft.com/ja-jp/windows/package-manager/">Windows パッケージ マネージャー</a></p>

<p><a href="https://www.reddit.com/r/sysadmin/comments/gmrwxi/windows_package_manager_wingetexe/">📢 Windows Package Manager  winget.exe : sysadmin</a></p>

<p>使いたい場合は
Windowsの<a href="https://insider.windows.com/ja-jp/">Insider</a>版を入れると
使える様になるとのことです。</p>

<p>PowerShellとかで</p>

<pre><code>PS &gt; winget instll firefox
</code></pre>

<p>とかでアプリやツールがインストールできる様になります。</p>

<p>Microsoft Storeに行くと<strong>アプリインストーラー</strong>というのがあって、これをインストールすると
使える様になるのですが、
このアプリ自体は以前から存在していて既にインストールされてるかもしれません。
以前のこれが入っていても<code>winget</code>は使えません。</p>

<p>Insiderを入れてるとプレビュー版の<strong>アプリインストーラー</strong>がインストール出来るようになるので、
Insiderにしてから再度<strong>アプリインストーラー</strong>を入れると<code>winget</code>が使える様になります。</p>

<p>これをインストールしてもInsider版にしておかないと使えるようにはならないみたいです。
(PowerShellで<code>winget</code>コマンドが使えない。)</p>

<p>直接
<a href="https://github.com/microsoft/winget-cli/releases">Releases</a>
から取れる、とも書いてあるんですが、今現在ここにある
<strong>http://microsoft.desktopappinstaller_8wekyb3d8bbwe.appxbundle/</strong>
がリンク切れになってます。</p>

<p>自分でビルドするのも準備が面倒なのでやってません。</p>

<p>Microsoftのネイティブなパッケージマネージャー、コマンドラインツール、
ということで期待されていて、
特にマルウェアなどの危険なパッケージを排除し、信頼性の高いものにしようとしているみたいです。</p>

<p>その辺りでサードパーティーなChocolateyなどとの違いを見せていこうとしているようです。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2014/07/30/computer-windows-chocolatey/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20131122_chocolatey_120_90.jpg" width="120" height="90" alt="20131122_chocolatey_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2014/07/30/computer-windows-chocolatey/">Chocolateyのアップデート</a></div></li></ul>

<p>まだ開発は途上段階、といった感じで
パッケージをアップデートする、などは出来なかったりするみたいです。</p>

<p><a href="https://github.com/microsoft/winget-cli/issues/120">–update · Issue #120 · microsoft/winget-cli</a></p>

<h2 id="packagemanagement">PackageManagement…?</h2>

<p>と、サードパーティー製のものは今もある、という話ですが、
実はネイティブなパッケージマネージャーも以前出しています。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/1849756570?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=1849756570&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/51ITdNrjmqL._SS90_CR0,0,120,90_.jpg" alt="Deliciously Chocolatey: 100 Cocoa-rich Recipes for Bakes, Cakes and Chocolate Treats" /></a>
</div></div><a class="click_box_link" href="https://rcmdnk.com/blog/2016/03/11/computer-windows-chocolatey-packagemanagement/">Windows 10でPackageManagement (OneGet) + Chocolateyでアプリ管理</a></div></li></ul>

<p>元々<a href="https://github.com/OneGet/oneget">OneGet</a>と言われていたものが
PackageManagementというプロジェクト?となりました。</p>

<p><a href="https://docs.microsoft.com/ja-jp/powershell/module/packagemanagement/?view=powershell-6">PackageManagement</a></p>

<p><a href="https://ja.wikipedia.org/wiki/PackageManagement">PackageManagement - Wikipedia</a></p>

<p>これを使って</p>

<pre><code>PS &gt; Install-Package Firefox
</code></pre>

<p>とかやるとインストールが出来るようになってました。
このコマンドは最初からインストールされています。</p>

<p>PackageManagementはCoholateyなどのレポジトリも使うことが出来、
それらサードパーティ製のレポジトリのラッパーツール的な使い方も出来ました。</p>

<p>なのでこれを使ってたんですが、いつのまにやらコマンドは使えるものの、</p>

<p>一方、Chocolateyの方は使えたのでそちらを使ってました。</p>

<p>で、今回こんな話が出てきたので、PackageManagementのアップデートか?
と思ったらどうやら全く別のものな模様。</p>

<p>最近のPackageManagementをちょっと探ってみると、どうやら一応使えてる人は使えてるみたい?
(でもやっぱり手元でやってみるとうまくいかない。。。)</p>

<p><a href="https://github.com/oneget/oneget">レポジトリ</a>
の方は1ヶ月位前にはアップデートがありますが、リリースは1年くらい前が最後。</p>

<p>なのでこちらは無くなる感じ?</p>

<p>あと、今回のWindows Package Managerの話が出てくる所で<code>OneGet</code>という単語は出てくるんですが、
<code>PackageManagement</code>という単語は見かけませんでした。</p>

<p>PackageManagementというものが認知度が低かったのか、ほぼなかったことにされそうな感じ?</p>

<p>PackageManagementがそもそもなんで<code>Management</code>という名前がツールとして微妙だな、と思ってましたが、
新しいのは<code>Manager</code>とそれっぽい感じ。
ただ、Widnows Package Managerとはまたそのままだな、と。</p>

<h2 id="まとめ">まとめ</h2>

<p>ということで、まだ実際に触ってないのですが、PackageManagementは?と思ったので書いておきました。</p>

<p>WSL2とかもあるので、Insider入れて色々と見てみても良いかな、と思い始めた今日このごろ。</p>

]]></content>
  </entry>
  
</feed>
