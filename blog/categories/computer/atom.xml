<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Computer | rcmdnk's blog]]></title>
  <link href="https://rcmdnk.com/blog/categories/computer/atom.xml" rel="self"/>
  <link href="https://rcmdnk.com/"/>
  <updated>2022-03-07T00:51:01+00:00</updated>
  <id>https://rcmdnk.com/</id>
  <author>
    <name><![CDATA[rcmdnk]]></name>
    <email><![CDATA[rcmdnk@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[二酸化炭素濃度、温度、湿度計の比較]]></title>
    <link href="https://rcmdnk.com/blog/2022/02/20/computer-iot/"/>
    <updated>2022-02-20T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2022/02/20/computer-iot</id>
    <content type="html"><![CDATA[<p>色々と二酸化炭素やら温度やら湿度やらを記録してるので
このあたりで一旦それぞれの値を比較してみる。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#記録してる機器" id="markdown-toc-記録してる機器">記録してる機器</a></li>
  <li><a href="#温度の比較" id="markdown-toc-温度の比較">温度の比較</a></li>
  <li><a href="#湿度の比較" id="markdown-toc-湿度の比較">湿度の比較</a></li>
  <li><a href="#二酸化炭素濃度" id="markdown-toc-二酸化炭素濃度">二酸化炭素濃度</a></li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="記録してる機器">記録してる機器</h2>

<ul>
  <li>MH-Z19B/MH-Z19C (on Raspberry Pi): 二酸化炭素濃度、温度 (Google Sheets、1分単位)</li>
  <li>BME280 (on Raspberry Pi): 温度、湿度、気圧 (Google Sheets、1分単位)</li>
  <li>Nature Remo mini: 温度 (Google Sheets、1分単位)</li>
  <li>PTH-8: 二酸化炭素濃度、温度、湿度 (アプリからエクスポート、1時間単位)</li>
  <li>シャープ加湿空気清浄機KI-JS50: 温度、湿度（アプリで確認するだけ、10分単位?)</li>
</ul>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2022/01/06/computer-iot-raspberrypi/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20220106_raspifin1_120_90.jpg" width="120" height="90" alt="20220106_raspifin1_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2022/01/06/computer-iot-raspberrypi/">Raspberry Pi Zeroの室内測定器を基盤で実装</a></div></li></ul>
<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B097DNC871?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B097DNC871&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61tC8I8iusL._SS90_CR0,0,120,90_.jpg" alt="Protmex co2センサー CO2測定器 リアルタイム遠隔監視 二酸化炭素濃度計 アラーム機能 18650mAh大容量電池温度 湿度表示付き 高精度 空気質検知器 ポータブル 測定器 検測機 USB充電式 日本語説明書付き" /></a>
</div></div><a class="click_box_link" href="https://rcmdnk.com/blog/2022/02/19/computer-iot/">PTH-8: スマホで確認できる二酸化炭素濃度計</a></div></li></ul>
<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail"><div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07JG3RZXR?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07JG3RZXR&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61Mmz%2BqChqL._SS90_CR0,0,120,90_.jpg" alt="シャープ 加湿 空気清浄機 プラズマクラスター 25000 ハイグレード 13畳 / 空気清浄 23畳 2018年モデル グレー KI-JS50-H" /></a>
</div></div><a class="click_box_link" href="https://rcmdnk.com/blog/2021/01/25/life-iot-shopping/">加湿器調査: シャープの加湿空気清浄機KI-JS50購入(IoT)</a></div></li></ul>

<p>という感じで記録があって見ることが出来るようになっています。</p>

<p>あと一応エアコンもアプリとかでエアコンを表示できますが、過去の記録が見たりはできないので参考程度。</p>

<h2 id="温度の比較">温度の比較</h2>

<p>以前Nature Remo(NR)とBME 280(BME)の温度の値を比較したもの。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2021/01/15/computer-raspberrypi-iot-google/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20210115_both_120_90.jpg" width="120" height="90" alt="20210115_both_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2021/01/15/computer-raspberrypi-iot-google/">Nature RemoとBME 280 (RaspberryPi)での気温測定の比較</a></div></li></ul>

<p>このときは比較的良く合ってるようにみえました。</p>

<p>もうちょっと前のデータも見てみると、最初期(2020年9月16日)のものはこんな感じ。</p>

<p><img src="https://rcmdnk.com/images/post/20220220_temp_2020.jpg" alt="20220220_temp_2020.jpg" class="pic" /></p>

<p>ちょっとレンジが短いのでずれてるように見えますが、Nature Remoの温度計は0.5度単位でしかでないので、
ずれとしてはその1単位あるかないか、位で結構よく合ってます。</p>

<p>ちなみにNature RemoとBME 280の載ったRaspberry Pi Zeroは同じ場所においてあります。</p>

<p>1年ほど前にMH-Z19Bを導入したので、そのころ(2021年2月22日)のデータを見てみるとこんな感じ。</p>

<p><img src="https://rcmdnk.com/images/post/20220220_temp_2021.jpg" alt="20220220_temp_2021.jpg" class="pic" /></p>

<p>BME 280(BME)とNature Remo(NR)の値はNRの方が1度くらい高い感じにはなってます。</p>

<p>一方でMH-Z19B(MH-Z19)の出力はBME 280と比べると4度くらい高く結構違います。</p>

<p>2月末なので暖房をつけるかつけないかのようなときですが、
夜中つけてないときに24度ということは高すぎますし、
暖房の設定は結構低めにしてるのでNature Remo/BME 280の方が正しいです。</p>

<p>MH-Z19Bに関しては二酸化炭素濃度の測定がメインで、温度も一応取れるということでとってましたが
あまり合ってないな、と思いつつ、そんなものかと思って放置してました。
(ただ、もしかするとこのZ19Bはニセモノで精度がわるいものだったかもしれません。。。)</p>

<p>そして最新(2022年2月2月15日)の比較がこれ</p>

<p><img src="https://rcmdnk.com/images/post/20220220_temp.jpg" alt="20220220_temp.jpg" class="pic" />
<img src="https://rcmdnk.com/images/post/20220220_sharp.jpg" alt="20220220_sharp.jpg" class="pic" /></p>

<p>PTH-8が加わり、また別途KI-JS50のスクリーンショットも。
PTH-8はRaspberry PiやNature Remoと同じ所においてありますが、
KI-JS50は同じ部屋ですがちょっと離れたところに置かれています。</p>

<p>MH-Z19というのがMH-Z19Cに変わっていて、より安定的に測定できるようになっています。</p>

<p>温度もより正確になっているのかNature Remoとほとんど同じ動きをしています。</p>

<p>また、新たに加わったPTH-8(PTH)も大体同じような数字を示しています。</p>

<p>KI-JS50もこれらとだいたい同じ温度を示しているように見えます。</p>

<p>ところがBME 280(BME)が結構高めの数字を出しています。</p>

<p>現在エアコンの設定は23度になるような設定なので、
NR/MH-Z19/PTHは割と正確な値を出してそうです。</p>

<p>一方でBMEは明らかに高い。</p>

<p>以前はNature Remoと同じような値を示していたのでなんか狂ってしまったらしい。</p>

<p>BME 280では数字を読み込む際に事前にセンサーからキャリブレーション情報を読み込んで
色々と測定情報を計算する必要がありますが、
それらは工場出荷時に調整されたものなのでハードウェア的にずれてくると実際ずれてしまうのかも。</p>

<p>ハードウェアを特定の温度でキャリブレーションしたりする機能は無さそう。</p>

<blockquote>
  <p><a href="https://forum.arduino.cc/t/bme-reading-a-degree-too-high-calibration-help-solved/606088/16">BME reading a degree too high; calibration help <strong>SOLVED</strong> - Using Arduino / Sensors - Arduino Forum</a></p>
</blockquote>

<p>これとか見ると、適当にオフセットつければ？的な感じになってるのでそうするのが良い?</p>

<p>ちょっとその後も何日かみてみると</p>

<p><img src="https://rcmdnk.com/images/post/20220220_templong.jpg" alt="20220220_templong.jpg" class="pic" /></p>

<p>こんな感じでずっと同じような間隔でずれています。</p>

<p>ぱっと見、無理に温度ごとに変えなくても-4度とか入れておけば良さそうな感じはしてます。
その辺もRaspberry Piでただ数字とってるだけなのでやろうと思えば簡単に出来るので。</p>

<h2 id="湿度の比較">湿度の比較</h2>

<p>PTH-8が湿度を測れるようになったので
湿度の方も最新(2022年2月2月15日)の比較</p>

<p><img src="https://rcmdnk.com/images/post/20220220_humi.jpg" alt="20220220_humi.jpg" class="pic" /></p>

<p>まず、両者で10%も違う値を示しています。</p>

<p>上にあるKI-JS50の値を見てみると、
両者の間くらい。。。</p>

<p>一番高いところで</p>

<ul>
  <li>PTH: 55%</li>
  <li>KI-JS50: 50%</li>
  <li>BME: 40%</li>
</ul>

<p>昼間の安定してるっぽいところが</p>

<ul>
  <li>PTH: 45%</li>
  <li>KI-JS50: 37%</li>
  <li>BME: 33%</li>
</ul>

<p>くらい。</p>

<p>微妙すぎる。。。</p>

<p>これもちょっと長めに見てみると</p>

<p><img src="https://rcmdnk.com/images/post/20220220_humilong.jpg" alt="20220220_humilong.jpg" class="pic" /></p>

<p>日によっては差は5%も無いようなところも見れます。</p>

<p>KI-JS50の方の<a href="https://rcmdnk.com/images/post/20220220_sharp0216.jpg">2月16日</a>、<a href="https://rcmdnk.com/images/post/20220220_sharp0217.jpg">2月17日</a>、<a href="https://rcmdnk.com/images/post/20220220_sharp0218.jpg">2月18日</a>、<a href="https://rcmdnk.com/images/post/20220220_sharp0219.jpg">2月19日</a>も含めてみると、
常にBME280が一番高く、PTH-8が一番低い感じではありますが、その感覚は湿度の高さによらず?結構まばらです。</p>

<p>これに関してはどう補正すべきかちょっと微妙なので、しばらく様子見で。</p>

<h2 id="二酸化炭素濃度">二酸化炭素濃度</h2>

<p>最後に二酸化炭素濃度。</p>

<p><img src="https://rcmdnk.com/images/post/20220220_co2.jpg" alt="20220220_co2.jpg" class="pic" /></p>

<p>MH-Z19CとPTH-8だけですが、2022年2月15日のもの。</p>

<p>これを見てみると、低いところでPTHが大きく下がってしまってはいますが、
高いところでは同じような値を示していて、それなりに正確な測定が出来ている様に見えます。</p>

<p>二酸化炭素濃度に関しては両者ともキャリブレーションが可能で、
外気を400ppmだと仮定してキャリブレーションし、
また、MH-Z19Cの方は24時間おきのキャリブレーションも実行しています。</p>

<p>これが良いかどうかはちょっと微妙なところで、そのタイミングが誰も居なくて一番低い状態で400ppmと思えれば良いんですが、
電源入れたタイミングから回るので実際には高いタイミングでやってる可能性もあり。
かといって、大きくずれたりしないし、また、なんか最初のうち変な値を示していてもそのうち落ち着くような様子も見えるので
いまは有効にしたまま動かしています。</p>

<p>実際外気はこの数年でも結構上がってきていて、きれいな空気のところでも400ppmを超えてきているので、
実際には室内とかだと人が居なくても400ppmは大きく超えてるものだと思ってます。</p>

<p>一方でキャリブレーションの関係で400ppmを使い、これが両者とも下限値なので
400ppm付近で正確な測定を求めるのは結構辛いかと。</p>

<p>実際問題としては800ppmくらいまでであれば室内としても空気は問題なく、
1000ppm超えてるとか、1500ppm超えた、とかがざっくりとでもわかって警告できればよいので、
そういった意味では
二酸化炭素濃度は割と良い感じに取れてる感じです。</p>

<h2 id="まとめ">まとめ</h2>

<p>手元にある機器で色々比べてみましたが</p>

<ul>
  <li>温度: MH-Z19C、Nature Remo、PTH-8、KI-JS50は妥当な数字を出している。
    <ul>
      <li>BME 280は以前は正しく測定できていたが、時間が経って狂った様にみえる(4度ほど高い)。Raspberry Pi側で数字を計算する時にoffsetを入れることで対応できそう。</li>
    </ul>
  </li>
  <li>湿度: PT8-8 &gt; KI-JS50 &gt; BME 280な感じで最大10%くらい違う。
    <ul>
      <li>ただその違いは結構日によって違う。</li>
    </ul>
  </li>
  <li>二酸化炭素濃度:
    <ul>
      <li>MH-Z19CとPTH-8で下限値の400ppm程度のところではズレが見えるが、1000ppmとか高いところでは一致していて正しい測定ができてそう。</li>
    </ul>
  </li>
</ul>

<p>BME280の温度に関してはoffsetをつけて対応しようかと思います。</p>

<p>湿度に関してはちょっと別なもう一個くらいリファレンスがほしいな、と思ったりはしましたが、またもうちょっと様子見。</p>

<p>一番測定が難しそうな二酸化炭素濃度に関しては、むしろきちんとキャリブレーションの機構がついていることもあり、
正確な数字を出していそうです。</p>

<p>BME 280(+Raspberry Pi zero)は2年以上殆ど休みなく動き続けてくれているので
ハード的にちょっとずれてきてしまってるということはあるのかもしれません。</p>

<p>MH-Z19CもPTH-8もまだ買って日が浅いので1年、2年みてみてどう変わるか、また見てみたいと思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PTH-8: スマホで確認できる二酸化炭素濃度計]]></title>
    <link href="https://rcmdnk.com/blog/2022/02/19/computer-iot/"/>
    <updated>2022-02-19T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2022/02/19/computer-iot</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B097DNC871?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B097DNC871&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61tC8I8iusL._SS200_.jpg" alt="Protmex co2センサー CO2測定器 リアルタイム遠隔監視 二酸化炭素濃度計 アラーム機能 18650mAh大容量電池温度 湿度表示付き 高精度 空気質検知器 ポータブル 測定器 検測機 USB充電式 日本語説明書付き" /></a>
</div>

<p>MH-Z19とRaspberry Piを使って二酸化炭素濃度を測ってますが、
別途スマホと連携できる二酸化炭素濃度計を買ってみました。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#pth-8" id="markdown-toc-pth-8">PTH-8</a></li>
  <li><a href="#機能" id="markdown-toc-機能">機能</a></li>
  <li><a href="#対応アプリ" id="markdown-toc-対応アプリ">対応アプリ</a></li>
  <li><a href="#精度" id="markdown-toc-精度">精度</a></li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="pth-8">PTH-8</h2>

<div class="amazon-box">
  <div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61SvQgxjUiS._SS200_.jpg" alt="二酸化炭素濃度計 sparoma CO2センサー 温度測定 湿度測定 3 in 1 高精度 NDIR方式 400-5000PPM測定範囲 リアルタイム監視 高濃度警報機能 アプリ連携 データシェア コンパクト 卓上型 スタンド付き 充電式 部屋 学校 会議室 飲食店 医療施設など適用 日本語説明書付き PTH-8" /></a>
</div>

  <div class="amazon-title">
    <a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">二酸化炭素濃度計 sparoma CO2センサー 温度測定 湿度測定 3 in 1 高精度 NDIR方式 400-5000PPM測定範囲 リアルタイム監視 高濃度警報機能 アプリ連携 データシェア コンパクト 卓上型 スタンド付き 充電式 部屋 学校 会議室 飲食店 医療施設など適用 日本語説明書付き PTH-8</a>
  </div>
  <div class="amazon-txt">
    <span class="amazon-link"><a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Amazonで見る</a></span>
    <span class="rakuten-link"><a href="//hb.afl.rakuten.co.jp/hgc/111f634c.5fb25e94.111f634d.1a56ae16/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F%E4%BA%8C%E9%85%B8%E5%8C%96%E7%82%AD%E7%B4%A0%E6%BF%83%E5%BA%A6%E8%A8%88+sparoma+CO2%E3%82%BB%E3%83%B3%E3%82%B5%E3%83%BC+%E6%B8%A9%E5%BA%A6%E6%B8%AC%E5%AE%9A+%E6%B9%BF%E5%BA%A6%E6%B8%AC%E5%AE%9A+3+in+1+%E9%AB%98%E7%B2%BE%E5%BA%A6+NDIR%E6%96%B9%E5%BC%8F+400-5000PPM%E6%B8%AC%E5%AE%9A%E7%AF%84%E5%9B%B2+%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E7%9B%A3%E8%A6%96+%E9%AB%98%E6%BF%83%E5%BA%A6%E8%AD%A6%E5%A0%B1%E6%A9%9F%E8%83%BD+%E3%82%A2%E3%83%97%E3%83%AA%E9%80%A3%E6%90%BA+%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%A7%E3%82%A2+%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88+%E5%8D%93%E4%B8%8A%E5%9E%8B+%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E4%BB%98%E3%81%8D+%E5%85%85%E9%9B%BB%E5%BC%8F+%E9%83%A8%E5%B1%8B+%E5%AD%A6%E6%A0%A1+%E4%BC%9A%E8%AD%B0%E5%AE%A4+%E9%A3%B2%E9%A3%9F%E5%BA%97+%E5%8C%BB%E7%99%82%E6%96%BD%E8%A8%AD%E3%81%AA%E3%81%A9%E9%81%A9%E7%94%A8+%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%AA%AC%E6%98%8E%E6%9B%B8%E4%BB%98%E3%81%8D+PTH-8%2F&amp;m=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F%E4%BA%8C%E9%85%B8%E5%8C%96%E7%82%AD%E7%B4%A0%E6%BF%83%E5%BA%A6%E8%A8%88+sparoma+CO2%E3%82%BB%E3%83%B3%E3%82%B5%E3%83%BC+%E6%B8%A9%E5%BA%A6%E6%B8%AC%E5%AE%9A+%E6%B9%BF%E5%BA%A6%E6%B8%AC%E5%AE%9A+3+in+1+%E9%AB%98%E7%B2%BE%E5%BA%A6+NDIR%E6%96%B9%E5%BC%8F+400-5000PPM%E6%B8%AC%E5%AE%9A%E7%AF%84%E5%9B%B2+%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E7%9B%A3%E8%A6%96+%E9%AB%98%E6%BF%83%E5%BA%A6%E8%AD%A6%E5%A0%B1%E6%A9%9F%E8%83%BD+%E3%82%A2%E3%83%97%E3%83%AA%E9%80%A3%E6%90%BA+%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%A7%E3%82%A2+%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88+%E5%8D%93%E4%B8%8A%E5%9E%8B+%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E4%BB%98%E3%81%8D+%E5%85%85%E9%9B%BB%E5%BC%8F+%E9%83%A8%E5%B1%8B+%E5%AD%A6%E6%A0%A1+%E4%BC%9A%E8%AD%B0%E5%AE%A4+%E9%A3%B2%E9%A3%9F%E5%BA%97+%E5%8C%BB%E7%99%82%E6%96%BD%E8%A8%AD%E3%81%AA%E3%81%A9%E9%81%A9%E7%94%A8+%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%AA%AC%E6%98%8E%E6%9B%B8%E4%BB%98%E3%81%8D+PTH-8%2F&amp;scid=af_url_txt&amp;link_type=text&amp;ut=eyJwYWdlIjoidXJsIiwidHlwZSI6InRlc3QiLCJjb2wiOjB9" rel="nofollow" target="_blank">楽天市場で見る</a></span>
  </div>
</div>

<p>正直これの正式名称が分からない(日本でもいろんな代理店的なところが色々名前出してて良くわからない。。。)のですが、
おそらくPTH-8というのは機種の名前としては正しい模様。</p>

<p>買ったものはPROTmexというブランドで製造元が深センフェビステクノロジー株式会社、でした。</p>

<div class="amazon-box">
  <div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61SvQgxjUiS._SS200_.jpg" alt="二酸化炭素濃度計 sparoma CO2センサー 温度測定 湿度測定 3 in 1 高精度 NDIR方式 400-5000PPM測定範囲 リアルタイム監視 高濃度警報機能 アプリ連携 データシェア コンパクト 卓上型 スタンド付き 充電式 部屋 学校 会議室 飲食店 医療施設など適用 日本語説明書付き PTH-8" /></a>
</div>

  <div class="amazon-title">
    <a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">二酸化炭素濃度計 sparoma CO2センサー 温度測定 湿度測定 3 in 1 高精度 NDIR方式 400-5000PPM測定範囲 リアルタイム監視 高濃度警報機能 アプリ連携 データシェア コンパクト 卓上型 スタンド付き 充電式 部屋 学校 会議室 飲食店 医療施設など適用 日本語説明書付き PTH-8</a>
  </div>
  <div class="amazon-txt">
    <span class="amazon-link"><a href="//www.amazon.co.jp/gp/product/B09BC3V1ZQ?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B09BC3V1ZQ&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Amazonで見る</a></span>
    <span class="rakuten-link"><a href="//hb.afl.rakuten.co.jp/hgc/111f634c.5fb25e94.111f634d.1a56ae16/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F%E4%BA%8C%E9%85%B8%E5%8C%96%E7%82%AD%E7%B4%A0%E6%BF%83%E5%BA%A6%E8%A8%88+sparoma+CO2%E3%82%BB%E3%83%B3%E3%82%B5%E3%83%BC+%E6%B8%A9%E5%BA%A6%E6%B8%AC%E5%AE%9A+%E6%B9%BF%E5%BA%A6%E6%B8%AC%E5%AE%9A+3+in+1+%E9%AB%98%E7%B2%BE%E5%BA%A6+NDIR%E6%96%B9%E5%BC%8F+400-5000PPM%E6%B8%AC%E5%AE%9A%E7%AF%84%E5%9B%B2+%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E7%9B%A3%E8%A6%96+%E9%AB%98%E6%BF%83%E5%BA%A6%E8%AD%A6%E5%A0%B1%E6%A9%9F%E8%83%BD+%E3%82%A2%E3%83%97%E3%83%AA%E9%80%A3%E6%90%BA+%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%A7%E3%82%A2+%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88+%E5%8D%93%E4%B8%8A%E5%9E%8B+%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E4%BB%98%E3%81%8D+%E5%85%85%E9%9B%BB%E5%BC%8F+%E9%83%A8%E5%B1%8B+%E5%AD%A6%E6%A0%A1+%E4%BC%9A%E8%AD%B0%E5%AE%A4+%E9%A3%B2%E9%A3%9F%E5%BA%97+%E5%8C%BB%E7%99%82%E6%96%BD%E8%A8%AD%E3%81%AA%E3%81%A9%E9%81%A9%E7%94%A8+%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%AA%AC%E6%98%8E%E6%9B%B8%E4%BB%98%E3%81%8D+PTH-8%2F&amp;m=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F%E4%BA%8C%E9%85%B8%E5%8C%96%E7%82%AD%E7%B4%A0%E6%BF%83%E5%BA%A6%E8%A8%88+sparoma+CO2%E3%82%BB%E3%83%B3%E3%82%B5%E3%83%BC+%E6%B8%A9%E5%BA%A6%E6%B8%AC%E5%AE%9A+%E6%B9%BF%E5%BA%A6%E6%B8%AC%E5%AE%9A+3+in+1+%E9%AB%98%E7%B2%BE%E5%BA%A6+NDIR%E6%96%B9%E5%BC%8F+400-5000PPM%E6%B8%AC%E5%AE%9A%E7%AF%84%E5%9B%B2+%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E7%9B%A3%E8%A6%96+%E9%AB%98%E6%BF%83%E5%BA%A6%E8%AD%A6%E5%A0%B1%E6%A9%9F%E8%83%BD+%E3%82%A2%E3%83%97%E3%83%AA%E9%80%A3%E6%90%BA+%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%A7%E3%82%A2+%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88+%E5%8D%93%E4%B8%8A%E5%9E%8B+%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%89%E4%BB%98%E3%81%8D+%E5%85%85%E9%9B%BB%E5%BC%8F+%E9%83%A8%E5%B1%8B+%E5%AD%A6%E6%A0%A1+%E4%BC%9A%E8%AD%B0%E5%AE%A4+%E9%A3%B2%E9%A3%9F%E5%BA%97+%E5%8C%BB%E7%99%82%E6%96%BD%E8%A8%AD%E3%81%AA%E3%81%A9%E9%81%A9%E7%94%A8+%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%AA%AC%E6%98%8E%E6%9B%B8%E4%BB%98%E3%81%8D+PTH-8%2F&amp;scid=af_url_txt&amp;link_type=text&amp;ut=eyJwYWdlIjoidXJsIiwidHlwZSI6InRlc3QiLCJjb2wiOjB9" rel="nofollow" target="_blank">楽天市場で見る</a></span>
  </div>
</div>

<p>こっちはsparomaというブランドらしいですが、中身は同じっぽい。</p>

<p>上のAmazonのページにもありますが、いろいろなブランド、会社が同じものを出していてどこがホントの製造元だかよくわからないのと、
そもそもホンモノとかニセモノとかあるのかもよく分からず。。。</p>

<p>まあ、試しということで、とりあえず一個買ってみました。
1万円くらいですが、センサーとか考えるとそれくらいは最低でもするな、というのは自分で作ってみてわかったところなので
それほど高いものではないと思ってます。</p>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2022/01/06/computer-iot-raspberrypi/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20220106_raspifin1_120_90.jpg" width="120" height="90" alt="20220106_raspifin1_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2022/01/06/computer-iot-raspberrypi/">Raspberry Pi Zeroの室内測定器を基盤で実装</a></div></li></ul>

<p>NDIR方式でWiFi機能もついてれば逆に5000円くらいだと測定センサーがなんなのか疑ってしまうレベル。</p>

<p>二酸化炭素濃度計ですが、温度と湿度も測ることができます。
micro USBでの電源形式ですが、内部電池があるので電源を外しても測定でき、
1日くらいなら充電しないでも測定できる感じでした。</p>

<h2 id="機能">機能</h2>

<p>丸い画面は結構見やすい感じで、二酸化炭素濃度を大々的に表示しています。</p>

<p>400~700ppmだと笑顔、700~1500ppmだと真顔、それ以上だとへの字口な顔を
数字の横の顔が示します。
また、上の方にあるランプも、それぞれの段階で、グリーン、オレンジ、レッドと変わります。
さらに1500ppmを超えるとブザーがなります(ならないようにすることもできる。)</p>

<p>といった感じで注意喚起もしてくれます。</p>

<p>二酸化炭素濃度に関するキャリブレーションを手動で行うことも出来、
裏にあるボタンふたつを3秒長押しした後、室外など400ppmになってそうなところに
200秒ほどおいておくとキャリブレーションしてくれます。</p>

<h2 id="対応アプリ">対応アプリ</h2>

<p>アプリはSmart Lifeというアプリを使います。</p>

<div class="app-box">
  <div class="app-img">
  <a href="//itunes.apple.com/jp/app/id1115101477?at=10lc94" rel="nofollow" target="_blank"><img src="https://is3-ssl.mzstatic.com/image/thumb/Purple126/v4/b4/ec/dd/b4ecdd11-6938-57d3-dcfb-de3bdfc9b2c8/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/200x200bb.jpg" alt="Smart Life - Smart Living" /></a>
</div>

  <div class="app-title">
    <a href="//itunes.apple.com/jp/app/id1115101477?at=10lc94" rel="nofollow" target="_blank">Smart Life - Smart Living</a>
  </div>
  <div class="app-developer">
    デベロッパ: <a href="https://apps.apple.com/jp/developer/volcano-technology-limited/id1541277944" target="_blank" rel="nofollow">Volcano Technology Limited</a>
  </div>
  <div class="app-price">無料</div>
  <div class="app-links">
    <span class="itunes-link"><a href="//itunes.apple.com/jp/app/id1115101477?at=10lc94" target="_blank" rel="nofollow"><img src="https://rcmdnk.com/images/appstore-lrg-ja.svg" alt="App Store" /></a></span>
    <span class="android-link"><a href="//play.google.com/store/search?q=Smart Life - Smart Living&amp;c=apps" target="_blank" rel="nofollow"><img src="https://rcmdnk.com/images/google-play-badge-ja.png" alt="Google Play" /></a></span>
  </div>
</div>

<p>これは上のPTH-8やその会社専用のもの、ではなく、他のいろいろな会社の商品でも使われています。</p>

<p>最近買ったもので、ニトリで買ったシーリングライトがこれ使ってました。</p>

<table border="0" cellpadding="0" cellspacing="0"><tr><td><div style="border:1px solid #95a5a6;border-radius:.75rem;background-color:#FFFFFF;width:504px;margin:0px;padding:5px;text-align:center;overflow:hidden;"><table><tr><td style="width:240px"><a href="https://hb.afl.rakuten.co.jp/ichiba/246eecca.4d06b937.246eeccb.0e865d6f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnitori%2F8380171%2F&amp;link_type=picttext&amp;ut=eyJwYWdlIjoiaXRlbSIsInR5cGUiOiJwaWN0dGV4dCIsInNpemUiOiIyNDB4MjQwIiwibmFtIjoxLCJuYW1wIjoicmlnaHQiLCJjb20iOjEsImNvbXAiOiJkb3duIiwicHJpY2UiOjEsImJvciI6MSwiY29sIjoxLCJiYnRuIjoxLCJwcm9kIjowLCJhbXAiOmZhbHNlfQ%3D%3D" target="_blank" rel="nofollow sponsored noopener" style="word-wrap:break-word;"><img src="https://hbb.afl.rakuten.co.jp/hgb/246eecca.4d06b937.246eeccb.0e865d6f/?me_id=1210615&amp;item_id=10261767&amp;pc=https%3A%2F%2Fthumbnail.image.rakuten.co.jp%2F%400_mall%2Fnitori%2Fcabinet%2F83801%2F838017101.jpg%3F_ex%3D240x240&amp;s=240x240&amp;t=picttext" border="0" style="margin:2px" alt="[商品価格に関しましては、リンクが作成された時点と現時点で情報が変更されている場合がございます。]" title="[商品価格に関しましては、リンクが作成された時点と現時点で情報が変更されている場合がございます。]" /></a></td><td style="vertical-align:top;width:248px;"><p style="font-size:12px;line-height:1.4em;text-align:left;margin:0px;padding:2px 6px;word-wrap:break-word"><a href="https://hb.afl.rakuten.co.jp/ichiba/246eecca.4d06b937.246eeccb.0e865d6f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnitori%2F8380171%2F&amp;link_type=picttext&amp;ut=eyJwYWdlIjoiaXRlbSIsInR5cGUiOiJwaWN0dGV4dCIsInNpemUiOiIyNDB4MjQwIiwibmFtIjoxLCJuYW1wIjoicmlnaHQiLCJjb20iOjEsImNvbXAiOiJkb3duIiwicHJpY2UiOjEsImJvciI6MSwiY29sIjoxLCJiYnRuIjoxLCJwcm9kIjowLCJhbXAiOmZhbHNlfQ%3D%3D" target="_blank" rel="nofollow sponsored noopener" style="word-wrap:break-word;">[幅47cm] 8畳用LEDシーリングライト フィフス ニトリ 【玄関先迄納品】 【1年保証】 〔合計金額11000円以上送料無料対象商品〕</a><br /><span>価格：4990円（税込、送料別)</span> <span style="color:#BBB">(2022/2/19時点)</span></p><div style="margin:10px;"><a href="https://hb.afl.rakuten.co.jp/ichiba/246eecca.4d06b937.246eeccb.0e865d6f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnitori%2F8380171%2F&amp;link_type=picttext&amp;ut=eyJwYWdlIjoiaXRlbSIsInR5cGUiOiJwaWN0dGV4dCIsInNpemUiOiIyNDB4MjQwIiwibmFtIjoxLCJuYW1wIjoicmlnaHQiLCJjb20iOjEsImNvbXAiOiJkb3duIiwicHJpY2UiOjEsImJvciI6MSwiY29sIjoxLCJiYnRuIjoxLCJwcm9kIjowLCJhbXAiOmZhbHNlfQ%3D%3D" target="_blank" rel="nofollow sponsored noopener" style="word-wrap:break-word;"><img src="https://static.affiliate.rakuten.co.jp/makelink/rl.svg" style="float:left;max-height:27px;width:auto;margin-top:0" /></a><a href="https://hb.afl.rakuten.co.jp/ichiba/246eecca.4d06b937.246eeccb.0e865d6f/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fnitori%2F8380171%2F%3Fscid%3Daf_pc_bbtn&amp;link_type=picttext&amp;ut=eyJwYWdlIjoiaXRlbSIsInR5cGUiOiJwaWN0dGV4dCIsInNpemUiOiIyNDB4MjQwIiwibmFtIjoxLCJuYW1wIjoicmlnaHQiLCJjb20iOjEsImNvbXAiOiJkb3duIiwicHJpY2UiOjEsImJvciI6MSwiY29sIjoxLCJiYnRuIjoxLCJwcm9kIjowLCJhbXAiOmZhbHNlfQ==" target="_blank" rel="nofollow sponsored noopener" style="word-wrap:break-word;"><div style="float:right;width:41%;height:27px;background-color:#bf0000;color:#fff!important;font-size:12px;font-weight:500;line-height:27px;margin-left:1px;padding: 0 12px;border-radius:16px;cursor:pointer;text-align:center;">楽天で購入</div></a></div></td></tr></table></div><br /><p style="color:#000000;font-size:12px;line-height:1.4em;margin:5px;word-wrap:break-word"></p></td></tr></table>

<p>ちなみに、PTH-8の商品ページによってはTuyaSmartアプリ、と書いてあるものもあります。</p>

<div class="app-box">
  <div class="app-img">
  <a href="//itunes.apple.com/jp/app/id1034649547?at=10lc94" rel="nofollow" target="_blank"><img src="https://is3-ssl.mzstatic.com/image/thumb/Purple126/v4/b2/7b/4e/b27b4edd-4ecb-6082-5f09-054a31699838/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/200x200bb.jpg" alt="Tuya Smart" /></a>
</div>

  <div class="app-title">
    <a href="//itunes.apple.com/jp/app/id1034649547?at=10lc94" rel="nofollow" target="_blank">Tuya Smart</a>
  </div>
  <div class="app-developer">
    デベロッパ: <a href="https://apps.apple.com/jp/developer/tuya-inc/id551919025" target="_blank" rel="nofollow">Tuya Inc.</a>
  </div>
  <div class="app-price">無料</div>
  <div class="app-links">
    <span class="itunes-link"><a href="//itunes.apple.com/jp/app/id1034649547?at=10lc94" target="_blank" rel="nofollow"><img src="https://rcmdnk.com/images/appstore-lrg-ja.svg" alt="App Store" /></a></span>
    <span class="android-link"><a href="//play.google.com/store/search?q=Tuya Smart&amp;c=apps" target="_blank" rel="nofollow"><img src="https://rcmdnk.com/images/google-play-badge-ja.png" alt="Google Play" /></a></span>
  </div>
</div>

<p>アイコンは全然違いますが、アプリの中身は見た目的に同じです。</p>

<p>なんなんだろうと調べてみると、
Tuyaという会社の方のQAに両方とも同じだし公式のアプリだ、と書いてありました。</p>

<blockquote>
  <p><a href="https://support.tuya.com/en/help/_detail/K9hrdz10p224e">What is the difference between Tuya Smart App and Smart Life App?</a></p>
</blockquote>

<p>ちょっと調べてみるとこんな記事が。</p>

<blockquote>
  <p><a href="https://www.smarthome.news/buyers-guides/other-systems/tuya-smart-vs-smart-life">Tuya Smart vs. Smart Life</a></p>
</blockquote>

<p>TuyaSmartアプリ、というものがもともとTuyaのスマート機器の展開用としてブランド化したもので、
一方でスマート機器業界の中でより中心的なポジションを得るためにアプリ(およびサーバー)を他の会社のスマート機器でも使えるようにし、
その際に自社ブランドのTuyaとは別の名前のSmart Lifeというアプリ名で広めていった、ということのようです。</p>

<p>ただし中身は全く一緒で、他社の機器もTuyaSmartアプリでも登録することは可能です。</p>

<p>ただ、それぞれのアプリでアカウントは別扱いなので、もう片方のアプリを使いたい場合には元のアプリに登録してあったものを一度削除しないといけないとのこと。</p>

<p>Smart LifeはIFTTTと連携出来るし、GoogleアシスタントやAmazon Alexaとも直接連携できます。</p>

<p>日本のメーカーも余計なもの独自に作らず全部こういうのにして欲しい。。。</p>

<p>アプリ上では現在地が見れるダッシュボードのようなものと、
二酸化炭素濃度、温度、湿度のそれぞれをグラフ形式で見れるものがあります。</p>

<p><img src="https://rcmdnk.com/images/post/20220219_smartlife1.jpg" alt="20220219_smartlife1.jpg" class="pic" /></p>

<p>グラフは1日分を1時間おき、1ヶ月分を1日おき、1年分を1ヶ月おきに表示することが出来ます。
なので保存されているデータは1時間おきのデータのようです。
これらのデータは2年分サーバーに保存されるとのこと。</p>

<p><img src="https://rcmdnk.com/images/post/20220219_smartlife2.jpg" alt="20220219_smartlife2.jpg" class="pic" />
<img src="https://rcmdnk.com/images/post/20220219_smartlife3.jpg" alt="20220219_smartlife3.jpg" class="pic" /></p>

<p>また、ちょっとわかりにくいですが、各グラフのページから右上にある四角+矢印のところを押すと電子メールアドレスへエクセルファイルへのリンクを送ることが出来ます。</p>

<p><img src="https://rcmdnk.com/images/post/20220219_mailinput.jpg" alt="20220219_mailinput.jpg" class="pic" /></p>

<p>この時にちょっと注意が必要で、メールアドレスに大文字を入れると、
<code>Email error, please enter again</code>と怒られます。</p>

<p><img src="https://rcmdnk.com/images/post/20220219_mailfail.jpg" alt="20220219_mailfail.jpg" class="pic" /></p>

<p>メールアドレスはメールを送る際には大文字、小文字は関係なく送れますが、
このアプリでは大文字があると送ってくれないようです。。。
(それに気づくまでに結構何回か試して分からなかった。。。)</p>

<p><img src="https://rcmdnk.com/images/post/20220219_mailok.jpg" alt="20220219_mailok.jpg" class="pic" /></p>

<p>送れるとこんな表示が出ますが、<code>OK</code>を押すとまたメールアドレスを入力する画面に戻って、失敗か？
と思いますが、メールは送られてるのでキャンセルで戻ってください(多分バグ)。</p>

<p>送れるとメールが来て、そこにデータの入ったエクセルシートへのリンクが載ってるのでそれをダウンロードします。</p>

<p>送られるデータはその時表示されているグラフのデータだけなので、
例えば、1ヶ月分の毎日の時間毎のデータをダウンロードしようとすると、
それぞれの日付を表示してエクスポートしないといけないのでけっこう大変です。</p>

<p>HomeAssistantとかでも使えるっぽいので、多分API的に取得することも可能だと思いますが、まだやってません。</p>

<p><strong>スマートカスタム</strong>という機能で、二酸化炭素濃度がいくつになったら何何する、みたいなことも設定できます。
他の機器を操作したりも出来るし、通知を鳴らすことも出来ます。
二酸化炭素濃度の上がりすぎの通知をスマホに流すことも簡単にできます。</p>

<h2 id="精度">精度</h2>

<p>機能的には便利そうだと思いますが、精度がなければ色々データが取れても意味がありません。</p>

<p>正確な比較をすることは出来ませんが、とりあえず手元のMH-Z19Cとの比較をします。</p>

<p>ちょっとそれに関しては次回。</p>

<h2 id="まとめ">まとめ</h2>

<p>二酸化炭素濃度計を買ってみましたが、
結構良いと思いました。</p>

<p>Raspberry Piで同じようなものを作ろうとしても同じくらいの値段になってしまうので
気軽にデータもオンラインで取れるならかなり便利かな、と。</p>

<p>現状だとスマホからデータをエクスポートするような形なのでデータの保存という意味ではあれなのと、
間隔も最短で1時間なのでそこはRaspberry Pi版よりかなり辛いところですが、
もしAPIとかで取得できるならかなり便利。</p>

<p>あとは中のセンサーの精度ですが、ちょっと見た感じではMH-Z19Cと同じ
ような数字を示しているのでおそらくMH-Z19Cも含めて両者ともある程度リーゾナブルに正しい数字をだしてるんじゃないかと。</p>

<p>PTH-5とか、Wi-Fiがついてないバージョンも7千円位で売ってるので、
無理にスマホで確認する必要が無い、という場合にはそれもおすすめです。</p>

<p>Raspberry Pi版を追加で作ろうかとも思ってるんですが、
Raspberry Pi Zero 2まだ日本で発売され地なくて、Zeroも普通には手に入らないような状態なので
またZero 2が発売されたら遊んでみようと思ってます。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AutoHotkeyでカーソル下の文字を見てアクションを変える]]></title>
    <link href="https://rcmdnk.com/blog/2022/02/16/computer-windows-autohotkey/"/>
    <updated>2022-02-16T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2022/02/16/computer-windows-autohotkey</id>
    <content type="html"><![CDATA[<p>AuotHotkeyで何らかアクションを起こす時に
カーソル下の文字を見てアクションを変える方法を覚えたのでそれについて。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#やりたいこと" id="markdown-toc-やりたいこと">やりたいこと</a></li>
  <li><a href="#方法" id="markdown-toc-方法">方法</a></li>
  <li><a href="#hotstrings" id="markdown-toc-hotstrings">Hotstrings</a></li>
  <li><a href="#a_thishotkey" id="markdown-toc-a_thishotkey">A_ThisHotkey</a></li>
  <li><a href="#sleep-or-clipwait" id="markdown-toc-sleep-or-clipwait">Sleep or Clipwait</a></li>
  <li><a href="#その他で活用できそうな所" id="markdown-toc-その他で活用できそうな所">その他で活用できそうな所</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="やりたいこと">やりたいこと</h2>

<p>このIssueでもらったもの:</p>

<blockquote>
  <p><a href="https://github.com/rcmdnk/vim_ahk/issues/74">Normal mode ‘a’ behavior in the end of line · Issue #74 · rcmdnk/vim_ahk</a></p>
</blockquote>

<p><a href="https://github.com/rcmdnk/vim_ahk">vim_ahk</a>でノーマルモード中、
<i class="key">A</i>を押すとカーソルの右側に移動してインサートモードに移る機能があります。
これは単に<i class="key">right</i>を入力してモード変換をしているだけです。</p>

<p>これが行末の場合、次の行に行ってしまいます。</p>

<p>一方、実際のVimでは行末で<i class="key">A</i>を押すとその行にとどまってインサートモードに入ります。
正確にはVimのノーマルモードではカーソルは各文字の上にあるような形になっていて、これは通常時の文字の左側にカーソルがあるのと同じです。
そして行末、というのが最終文字、となっているので実際には最後から一文字手前のところにカーソルがあることになります。
なのでそこから<i class="key">A</i>するとその行の最後から書き始め、になります。</p>

<p>これを実際のVimっぽくしたい、と。</p>

<h2 id="方法">方法</h2>

<p>この問題は分かってましたが行末とかわからないしな、と思って取り組めてませんでしたが、
良い参考を教えてもらいました。</p>

<blockquote>
  <p><a href="https://www.reddit.com/r/AutoHotkey/comments/4ma5b8/identifying_end_of_line_when_typing_with_ahk_and/">Identifying “End of Line” when typing with AHK? And implementing it into a hotstring. : AutoHotkey</a></p>
</blockquote>

<p>ここにある例がまさに行末の判定をしてアクションを変えていて、ほぼそのまま使えます。</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span>  <span class="n">CheckChr</span><span class="p">(</span><span class="n">key</span><span class="p">){</span>
</span><span class="line">    <span class="nb">BlockInput</span><span class="p">,</span> <span class="n">Send</span>
</span><span class="line">    <span class="n">tempClip</span> <span class="o">:=</span> <span class="nv">clipboard</span>
</span><span class="line">    <span class="nv">clipboard</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
</span><span class="line">    <span class="nb">SendInput</span> <span class="p">{</span><span class="n">Shift</span> <span class="n">Down</span><span class="p">}{</span><span class="n">Right</span><span class="p">}{</span><span class="n">Shift</span> <span class="n">up</span><span class="p">}{</span><span class="n">Ctrl</span> <span class="n">down</span><span class="p">}</span><span class="n">c</span><span class="p">{</span><span class="n">Ctrl</span> <span class="n">Up</span><span class="p">}{</span><span class="n">Left</span><span class="p">}</span>
</span><span class="line">    <span class="nb">Sleep</span> <span class="mi">10</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">:=</span> <span class="nv">False</span>
</span><span class="line">    <span class="n">If</span> <span class="p">(</span><span class="nv">clipboard</span> <span class="o">~=</span> <span class="n">key</span><span class="p">){</span>
</span><span class="line">      <span class="n">ret</span> <span class="o">:=</span> <span class="nv">True</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nb">sleep</span> <span class="mi">10</span>
</span><span class="line">    <span class="nv">clipboard</span> <span class="o">:=</span> <span class="n">tempClip</span>
</span><span class="line">    <span class="nb">BlockInput</span><span class="p">,</span> <span class="n">off</span>
</span><span class="line">    <span class="nb">Return</span> <span class="n">ret</span>
</span><span class="line">  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<blockquote>
  <p>https://github.com/rcmdnk/vim_ahk/blob/98759b8a692896fa96c0b1e96d2a325847ce542d/lib/vim_ahk.ahk#L278</p>
</blockquote>

<p>こんな感じの関数を用意して、カーソル下の文字が引数にいれる文字と一致するかどうかをチェックします。</p>

<p>AutoHotkeyでは<code>clipboard</code>という変数がWindowsのクリップボードの値と同期しているのでそれを使います。</p>

<p>このアクションが起こった後にクリップボードを変更したくないので元の値を一旦退避して、</p>

<ul>
  <li><i class="key">Shift</i>-<i class="key">Right</i></li>
</ul>

<p>で一文字選択した状態で</p>

<ul>
  <li><i class="key">Ctrl</i>-<i class="key">C</i></li>
</ul>

<p>でコピーする、という作業をします。</p>

<p>コピーした後にその中身が何かをチェックしています。</p>

<p>あとは
AutoHotkeyでの改行は`nなので、
こんな感じで改行コードでない場合だけ右にいくようにするだけ。</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span><span class="nl">a::</span>
</span><span class="line">  <span class="n">if</span><span class="p">(</span><span class="o">!</span> <span class="n">Vim</span><span class="o">.</span><span class="n">CheckChr</span><span class="p">(</span><span class="s">&quot;</span><span class="se">`n</span><span class="s">&quot;</span><span class="p">)){</span>
</span><span class="line">    <span class="nb">Send</span><span class="p">,</span> <span class="p">{</span><span class="n">Right</span><span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="n">Vim</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">SetMode</span><span class="p">(</span><span class="s">&quot;Insert&quot;</span><span class="p">)</span>
</span><span class="line"><span class="nb">Return</span>
</span></code></pre></td></tr></table></div></figure>

<blockquote>
  <p>https://github.com/rcmdnk/vim_ahk/blob/98759b8a692896fa96c0b1e96d2a325847ce542d/lib/bind/vim_enter_insert.ahk#L9</p>
</blockquote>

<p>以下、元の参考を見て新たに知ったこととかよく分かってないこととか。</p>

<h2 id="hotstrings">Hotstrings</h2>

<p>元の参考コードは括弧を自動で閉じる機能ですが、
キーバインド部を</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span><span class="o">:*:</span><span class="p">{</span><span class="o">::</span>
</span><span class="line">    <span class="n">EOL</span><span class="p">(</span><span class="n">StrReplace</span><span class="p">(</span><span class="nv">A_ThisHotkey</span><span class="p">,</span> <span class="s">&quot;:*:&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>こんな感じにしています。</p>

<p>この<code>:*:{::</code>ですが、<code>:*:{</code>が左辺で<code>::</code>を境にして設定される側とそれに対するアクション(キー)が書かれています。</p>

<p>左辺に<code>:</code>が2つあるのが
<a href="https://www.autohotkey.com/docs/Hotstrings.htm">Hotstrings</a>
と呼ばれるもので、これは複数の入力文字に対してアクションを指定したい場合に使います。</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span><span class="o">::</span><span class="n">btw</span><span class="o">::</span><span class="n">by</span> <span class="n">the</span> <span class="n">way</span>
</span></code></pre></td></tr></table></div></figure>

<p>これだと<code>btw</code>と打った後に<i class="key">Space</i>、<i class="key">.</i>、<i class="key">Enter</i>のいずれかが押されると<code>btw</code>が<code>by the way</code>に変換されます。</p>

<p>この最初の<code>::</code>の間にはオプションを入れることができ、
<code>:*:</code>は上の指定キーを入力した瞬間に即座にアクションを実行する、というもの。</p>

<p><code>btw</code>の例だとスペースとかを押さなくてもすぐに変換されることになります。</p>

<p>スニペット的な感じ。</p>

<p>他のオプションとかは
<a href="https://www.autohotkey.com/docs/Hotstrings.htm">Hotstringsのドキュメント</a>
参照してください。</p>

<p>で、ここでは<code>{</code>とかだけをキーバインドしたいわけですが、
それに対して即時オプションを設定すると単に</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span><span class="p">{</span><span class="o">::</span>
</span><span class="line">    <span class="n">EOL</span><span class="p">(</span><span class="n">StrReplace</span><span class="p">(</span><span class="nv">A_ThisHotkey</span><span class="p">,</span> <span class="s">&quot;:*:&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>とするのと変わらない気が。。。</p>

<p>実際ちょっと試した限りではまったく同じように動作しました。</p>

<p>上の参考ページは5年前の記事なので、その間に変わったこととかがあるのかもしれませんし、
何かしら特殊な状況で必要なのかもしれませんが、それが何か分かってません。</p>

<h2 id="a_thishotkey">A_ThisHotkey</h2>

<p>キーバインドする際に、出力側で<code>A_ThisHotkey</code>を使うと入力の文字列になります。
(正確には最後に実行されたホットキーが格納されている。)</p>

<p>上の例だと</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span>    <span class="n">EOL</span><span class="p">(</span><span class="n">StrReplace</span><span class="p">(</span><span class="nv">A_ThisHotkey</span><span class="p">,</span> <span class="s">&quot;:*:&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>のようにして、<code>:*:{</code>とかなっているのを<code>SetReplace</code>できれいにして<code>{</code>として渡しています。</p>

<p>これはもしEOLがこれにしか使わないなら<code>SetReplace</code>を<code>EOL</code>の関数の中に入れてしまえば良いし、
もう一つラッパー関数を作っても良いかもしれません。</p>

<p>また、そもそもそれぞれのキーは決まっているので</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span>    <span class="n">EOL</span><span class="p">(</span><span class="s">&quot;{&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>そしてしまえば。</p>

<p>また、全部同じことをしたいなら，</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ahk"><span class="line"><span></span>    <span class="o">:*:</span><span class="p">{</span><span class="o">::</span>
</span><span class="line">    <span class="o">:*:</span><span class="p">[</span><span class="o">::</span>
</span><span class="line">    <span class="o">:*:</span><span class="p">(</span><span class="o">::</span>
</span><span class="line">      <span class="n">EOL</span><span class="p">(</span><span class="n">StrReplace</span><span class="p">(</span><span class="nv">A_ThisHotkey</span><span class="p">,</span> <span class="s">&quot;:*:&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
</span><span class="line">      <span class="nb">Return</span>
</span></code></pre></td></tr></table></div></figure>

<p>といった感じにまとめることもできます。</p>

<h2 id="sleep-or-clipwait">Sleep or Clipwait</h2>

<p>上の例では
<a href="https://www.autohotkey.com/docs/commands/Sleep.htm">Sleep</a>
を使っていますが、AutoHotkeyには
<a href="https://www.autohotkey.com/docs/commands/ClipWait.htm">ClipWait</a>
という機能もあります。</p>

<p>ClipWaitだとタイムアウト時間を設定してコピーが完了次第次に進めるのでそっちのが良さげ。</p>

<p>実はvim_ahkの中でClipWaitを使ってる箇所があります。</p>

<blockquote>
  <p><a href="https://github.com/rcmdnk/vim_ahk/blob/98759b8a692896fa96c0b1e96d2a325847ce542d/lib/bind/vim_normal.ahk#L14">vim_ahk/vim_normal.ahk at 98759b8a692896fa96c0b1e96d2a325847ce542d · rcmdnk/vim_ahk</a></p>
</blockquote>

<p>完全にどうやってるか、は忘れてましたが、<code>~</code>でカーソル下の文字を大文字小文字でトグルする機能で
文字の大小を見て変換する、という際にクリップボードを使っています。
ここではClipWaitを利用。</p>

<p>多分ClipWaitの方が良いんだと思いますが、ちょっとまたちゃんと調べてから変更しようかと思ってます。</p>

<h2 id="その他で活用できそうな所">その他で活用できそうな所</h2>

<p>vim_ahkの中で実際のVimと動作が微妙に違う部分はたくさんあって、
特に今回の例のようにカーソル下の状態とか、周辺の状況を把握しないと無理、というものが結構あります。</p>

<p>その辺あまりまとめて無かったんですが、
ざっと思いつくところからリストアップしてそのうちやろうかと。</p>

<blockquote>
  <p><a href="https://github.com/rcmdnk/vim_ahk/issues/76">use CheckChr, BlockInput for some places · Issue #76 · rcmdnk/vim_ahk</a></p>
</blockquote>

<p>クリップボード以外にも、ノーマルモードでh/j/k/lのような移動キーをキーリピートをすると文字が入力されてしまったりすることもあり、
この辺参考例の中にある
<a href="https://www.autohotkey.com/docs/commands/BlockInput.htm">BlockInput</a>
を使ったらうまく出来ないかな、とかも。</p>

<p>もし何か使ってて気になる点とかがあれば気軽にGitHubのIssueとか
Twitterとかでも良いので教えていただけるとありがたいです。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Amazon AlexaとIFTTTの連携はGoogleアシスタントに比べてひと手間必要]]></title>
    <link href="https://rcmdnk.com/blog/2022/02/14/computer-iot/"/>
    <updated>2022-02-14T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2022/02/14/computer-iot</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B08KJP7326?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B08KJP7326&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61P1nr7nw2L._SS200_.jpg" alt="Echo Show 5 (エコーショー5) 第2世代 - スマートディスプレイ with Alexa、2メガピクセルカメラ付き、ディープシーブルー" /></a>
</div>

<p>最近AmazonのEchoを買ってAlexaを使い始めたのですが、
その時にIFTTTとの連携でちょっと戸惑った件。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#買ったもの" id="markdown-toc-買ったもの">買ったもの</a></li>
  <li><a href="#iftttとの連携-トリガーの種類" id="markdown-toc-iftttとの連携-トリガーの種類">IFTTTとの連携: トリガーの種類</a></li>
  <li><a href="#iftttとの連携-トリガーの作り方" id="markdown-toc-iftttとの連携-トリガーの作り方">IFTTTとの連携: トリガーの作り方</a></li>
  <li><a href="#amazon-alexaの定形アクションへのiftttアクションの連携" id="markdown-toc-amazon-alexaの定形アクションへのiftttアクションの連携">Amazon Alexaの定形アクションへのIFTTTアクションの連携</a></li>
  <li><a href="#amazon-alexaの定形アクション単独利用" id="markdown-toc-amazon-alexaの定形アクション単独利用">Amazon Alexaの定形アクション単独利用</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="買ったもの">買ったもの</h2>

<p>ディスプレイのついたEcho Show 5。</p>

<div class="amazon-box">
  <div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B08KJP7326?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B08KJP7326&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/61P1nr7nw2L._SS200_.jpg" alt="Echo Show 5 (エコーショー5) 第2世代 - スマートディスプレイ with Alexa、2メガピクセルカメラ付き、ディープシーブルー" /></a>
</div>

  <div class="amazon-title">
    <a href="//www.amazon.co.jp/gp/product/B08KJP7326?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B08KJP7326&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Echo Show 5 (エコーショー5) 第2世代 - スマートディスプレイ with Alexa、2メガピクセルカメラ付き、ディープシーブルー</a>
  </div>
  <div class="amazon-txt">
    <span class="amazon-link"><a href="//www.amazon.co.jp/gp/product/B08KJP7326?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B08KJP7326&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank">Amazonで見る</a></span>
    <span class="rakuten-link"><a href="//hb.afl.rakuten.co.jp/hgc/111f634c.5fb25e94.111f634d.1a56ae16/?pc=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FEcho+Show+5+%28%E3%82%A8%E3%82%B3%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%BC5%29+%E7%AC%AC2%E4%B8%96%E4%BB%A3+-+%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4+with+Alexa%E3%80%812%E3%83%A1%E3%82%AC%E3%83%94%E3%82%AF%E3%82%BB%E3%83%AB%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%80%81%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%83%96%E3%83%AB%E3%83%BC%2F&amp;m=http%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2FEcho+Show+5+%28%E3%82%A8%E3%82%B3%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%BC5%29+%E7%AC%AC2%E4%B8%96%E4%BB%A3+-+%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4+with+Alexa%E3%80%812%E3%83%A1%E3%82%AC%E3%83%94%E3%82%AF%E3%82%BB%E3%83%AB%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%80%81%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%82%B7%E3%83%BC%E3%83%96%E3%83%AB%E3%83%BC%2F&amp;scid=af_url_txt&amp;link_type=text&amp;ut=eyJwYWdlIjoidXJsIiwidHlwZSI6InRlc3QiLCJjb2wiOjB9" rel="nofollow" target="_blank">楽天市場で見る</a></span>
  </div>
</div>

<p>通常1つ8,980円ですが、1月に2つで8,980円だった時に買いました。</p>

<p>Echo商品は11月のブラックフライデーの時に半額以下になりますし、
それ以外でも半額位になるのでとてもじゃないけど普段買う気になれないのが辛い所。。。</p>

<p>Google Nestとかも気付いたら半額で売ってるので正規の値段がなんなのか。</p>

<p>ともあれAlexaを使えるようになったので色々と試しています。</p>

<h2 id="iftttとの連携-トリガーの種類">IFTTTとの連携: トリガーの種類</h2>

<p>GoogleアシスタントもAmazon AlexaもIFTTTと連携できます。</p>

<ul>
  <li><a href="https://ifttt.com/google_assistant">Google Assistant works better with IFTTT</a></li>
  <li><a href="https://ifttt.com/amazon_alexa">Amazon Alexa works better with IFTTT</a></li>
</ul>

<p>どちらもIFTTTのTriggerとして利用できますが、</p>

<ul>
  <li>Google Assistant:
    <ul>
      <li>何らかの言葉を話しかけるのみ</li>
      <li>数字や文字列などの変数を含めてそれらを使うことも可能</li>
    </ul>
  </li>
</ul>

<p><img src="https://rcmdnk.com/images/post/20220214_googleassistant1.jpg" alt="20220214_googleassistant1.jpg" class="pic" /></p>

<ul>
  <li>Amazon Alexa:
    <ul>
      <li>話かける以外にも<strong>買い物リストに追加された時</strong>などAlexa側でのなんらかの変化もTriggerにできる</li>
      <li>ただし話かける言葉の中に変数などは入れられない</li>
    </ul>
  </li>
</ul>

<p><img src="https://rcmdnk.com/images/post/20220214_amazonalexa1.jpg" alt="20220214_amazonalexa1.jpg" class="pic" /></p>

<p>といった感じ。今の所リストのアップデートでどうこうとかは使ってないので<strong>話しかけたら</strong>というトリガーのみを使っています。
またGoogle Assistantの方でも数字や文字列などを渡してそれを見てどうこうするようなことは今の所していないので、
簡単な命令に対してそのまま何かを行う、ということをやっているだけです。</p>

<h2 id="iftttとの連携-トリガーの作り方">IFTTTとの連携: トリガーの作り方</h2>

<ul>
  <li>Google Assistant:
    <ul>
      <li>1つの動作に3つのフレーズを指定出来る</li>
      <li>受け答えのフレーズを指定できる</li>
      <li>言語を指定できる</li>
    </ul>
  </li>
</ul>

<p><img src="https://rcmdnk.com/images/post/20220214_googleassistant2.jpg" alt="20220214_googleassistant2.jpg" class="pic" /></p>

<ul>
  <li>Amazon Alexa:
    <ul>
      <li>1つのフレーズを指定するのみ</li>
    </ul>
  </li>
</ul>

<p><img src="https://rcmdnk.com/images/post/20220214_amazonalexa2.jpg" alt="20220214_amazonalexa2.jpg" class="pic" /></p>

<p>という感じ。</p>

<p>Google Assistantの方はこれで設定ができ、きちんとサービスが連携できていれば
「ねえグーグル、加湿器つけて」といえばこの動作は作動します。</p>

<p>Amazon Alexaの方も同じようなものだろうと作ってみたところ動かず。。。</p>

<h2 id="amazon-alexaの定形アクションへのiftttアクションの連携">Amazon Alexaの定形アクションへのIFTTTアクションの連携</h2>

<p>Amazon AlexaでIFTTTのアクションを実行するには、別途Alexa側で定形アクションを作ってあげないといけません。</p>

<p><strong>その他</strong>とかにある<strong>定形アクション</strong>から新しいアクションを作成します。</p>

<p><img src="https://rcmdnk.com/images/post/20220214_alexaaction1.jpg" alt="20220214_alexaaction1.jpg" class="pic" />
<img src="https://rcmdnk.com/images/post/20220214_alexaaction2.jpg" alt="20220214_alexaaction2.jpg" class="pic" />
<img src="https://rcmdnk.com/images/post/20220214_alexaaction3.jpg" alt="20220214_alexaaction3.jpg" class="pic" /></p>

<p><strong>定形アクション名</strong>は適当につけます。</p>

<p><strong>実行条件を設定</strong>としては<strong>音声</strong>を選んでフレーズを決めます。</p>

<p><img src="https://rcmdnk.com/images/post/20220214_alexaaction4.jpg" alt="20220214_alexaaction4.jpg" class="pic" /></p>

<p>この時、フレーズは7個まで違うものを使えます。</p>

<p><img src="https://rcmdnk.com/images/post/20220214_alexaaction5.jpg" alt="20220214_alexaaction5.jpg" class="pic" /></p>

<p>次に<strong>アクションを追加</strong>で、IFTTTのアクションを追加します。</p>

<p>IFTTTでAmazon Alexaを連携するとここに<strong>IFTTT</strong>が出てきます。</p>

<p><img src="https://rcmdnk.com/images/post/20220214_alexaaction6.jpg" alt="20220214_alexaaction6.jpg" class="pic" /></p>

<p>IFTTTを選ぶとIFTTTで設定したAlexaをトリガーとしたアクションが出てきます。</p>

<p><img src="https://rcmdnk.com/images/post/20220214_alexaaction7.jpg" alt="20220214_alexaaction7.jpg" class="pic" /></p>

<p>ここから必要なものを選べばOK。</p>

<p>これで<strong>実行条件を設定</strong>で指定した言葉をしゃべりかければ
IFTTTで設定したアクションが実行されます。</p>

<p>と、ここまで来て気づくんですが、これ、IFTTT側で指定したフレーズが全く関係なくなってます。</p>

<p>色々見てもこのやり方しか無いっぽいのですが、謎仕様。
もともとは直接言葉を指定していたけど後から<strong>定形アクション</strong>が出来た、とか歴史的な経緯とかでもあるのでしょうか？</p>

<p>IFTTTを使う場合には微妙に面倒なのと、
Google Assistantを先に使っていて慣れていると最初うまく動かずにとまどってしまいます。</p>

<h2 id="amazon-alexaの定形アクション単独利用">Amazon Alexaの定形アクション単独利用</h2>

<p><strong>定形アクション</strong>ではIFTTT以外にもデバイスそのものを選ぶことも出来ます。</p>

<p>なのでAlexaに直接連携できているデバイスであればIFTTTなしでも直接操作を指定することもできます。</p>

<p>この点はGoogle Assistantよりも便利です。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Withings APIの変更に関してGASでの対応がちょっと面倒だった]]></title>
    <link href="https://rcmdnk.com/blog/2022/02/02/computer-iot/"/>
    <updated>2022-02-02T00:00:00+00:00</updated>
    <id>https://rcmdnk.com/blog/2022/02/02/computer-iot</id>
    <content type="html"><![CDATA[<div class="amazon-img">
  <a href="//www.amazon.co.jp/gp/product/B07B4TRQ3G?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B07B4TRQ3G&amp;linkCode=shr&amp;tag=rcmdnk0c-22" rel="nofollow" target="_blank"><img src="https://images-na.ssl-images-amazon.com/images/I/710HXJA4JtL._SS200_.jpg" alt="Withings Body Cardio フランス生まれのスマート体重計 ブラック Wi-Fi/Bluetooth対応 心臓の健康チェック（心拍/血管年齢）&amp;体組成計 【日本正規代理店品】 WBS04-BLACK-ALL-ASIA" /></a>
</div>

<p>WithingsのAPIの変更があり、2022年2月8日に以前のAPIが使えなくなるということでそれに対応した話。</p>

<!-- more -->

<ul id="markdown-toc">
  <li><a href="#withings-apiの変更" id="markdown-toc-withings-apiの変更">Withings APIの変更</a></li>
  <li><a href="#withings-gas" id="markdown-toc-withings-gas">Withings-gas</a></li>
  <li><a href="#access_tokenの仕様" id="markdown-toc-access_tokenの仕様">access_tokenの仕様</a></li>
</ul>
<div class="group"></div>

<div class="center_wrapper">
  <div>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3802317723662375" data-ad-slot="5762198341"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  </div>
</div>

<h2 id="withings-apiの変更">Withings APIの変更</h2>

<ul class="post_card"><li class="index_click_box"><div class="group"><div class="title-small-thumbnail">
  <a href="https://rcmdnk.com/blog/2020/10/06/computer-iot-google/"><img class="small-thumbnail-img" src="https://rcmdnk.com/images/post/thumbnail/20201006_withingsapi_120_90.jpg" width="120" height="90" alt="20201006_withingsapi_120_90" /></a>
</div><a class="click_box_link" href="https://rcmdnk.com/blog/2020/10/06/computer-iot-google/">Withings APIをとGASを使って体重変化などをGoogle Spreadsheetsに保存する</a></div></li></ul>

<p>Withingsの体重計の測定結果やSleepの睡眠測定結果などをGoogle App Script (GAS)を使って
Google Sheetsにコピーしています。</p>

<p>これに使っているAPIが変更されるとのこと。</p>

<p><a href="https://support.withings.com/hc/en-us/articles/360016745358-Deprecating-access-and-refresh-tokens-endpoints">[BREAKING] Shutting down access and refresh tokens endpoints – Withings Support</a></p>

<p>ちゃんと見てなかったんですが、去年の3月16日にアナウンスされていて、
古いAPIは今年の2月8日で使えなくなる、とのこと。</p>

<p>認証に使うエンドポイントのURLとかが変わるのでまずはそれを変更しなくてはいけませんが、
送るパラメーターや帰ってくるパラメーターも変わるのでちゃんと見てやる必要があります。</p>

<p>主にはGoogleが作っている
<a href="https://github.com/googleworkspace/apps-script-oauth2">googleworkspace/apps-script-oauth2</a>
というOAuth2を扱うライブラリを使っているのでそこでの取り扱いの変更です。</p>

<h2 id="withings-gas">Withings-gas</h2>

<div class="github-widget" data-repo="rcmdnk/Withings-gas"></div>

<p>こんな感じのApp Scriptでやっています。</p>

<p>まずは<strong>Withings.gs/getService()</strong>の中の<code>setTokenUrl</code>の変更:</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="diff"><span class="line"><span></span><span class="gd">- .setTokenUrl(&#39;https://account.withings.com/oauth2/token&#39;)</span>
</span><span class="line"><span class="gi">+ .setTokenUrl(&#39;https://wbsapi.withings.net/v2/oauth2&#39;)</span>
</span></code></pre></td></tr></table></div></figure>

<p>これだけで済めば良いのですが、他がちょっと面倒でした。</p>

<p>新しいAPIではToken取得時に<code>action</code>というパラメーターが必須になっています。</p>

<p>このToken取得時に必要なパラメーターは<strong>getService()</strong>の中で</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="diff"><span class="line"><span></span><span class="gi">+ // Set Token Payload Handler</span>
</span><span class="line"><span class="gi">+ .setTokenPayloadHandler(myHandler)</span>
</span></code></pre></td></tr></table></div></figure>

<p>と、<code>setTokenPayloadHander</code>を使って関数を使って追加する必要があります。この<code>myHandler</code>を</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span></span><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * TokenPayloadHandler</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">function</span> <span class="nx">myHandler</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="s1">&#39;requesttoken&#39;</span><span class="p">;</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">payload</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>最初の認証の際に必要なパラメーターは<code>setParam('parameter', 'value')</code>みたいな感じでセットできますが、
Token取得時のものはこの様に関数を使って加える必要があります。</p>

<p>これに失敗すると、認証ページに行ってCallback関数が呼ばれた時、</p>

<pre><code>Error: Error retrieving token: Not implemented（行 553、ファイル「Service」）
</code></pre>

<p>みたいなエラーが表示されます。これが出た場合はToken取得時に<code>action</code>の値などが正しくせっとされてません。</p>

<p>うまくいくとapps-script-oauth2のexample通りにCallback関数を作っていれば<code>Sucess!</code>が出るはず。</p>

<p>これでScriptsに戻ってもう一度実行すればうまく取得できるかと思ったら、今度はスクリプト実行時に</p>

<pre><code>Error: Withings API returns wrong status: 
{"status":401,"body":{},"error":"XRequestID: Not provided invalid_token: The access token provided is invalid"}
</code></pre>

<p>これを調べてみると、APIで値を取得時に、</p>

<figure class="code"><figcaption><span>Withings.gs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span></span>  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">Authorization</span><span class="o">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="nx">service</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">()</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="nx">payload</span><span class="o">:</span> <span class="nx">payload</span>
</span><span class="line">  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<p>といった感じでヘッダーを定義しているのですが、この<code>service.getAccessToken()</code>の値が<code>null</code>になっていました。</p>

<p>この関数は</p>

<figure class="code"><figcaption><span>OAuth2.gs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span></span><span class="nx">Service_</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAccessToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">hasAccess</span><span class="p">())</span> <span class="p">{</span>
</span><span class="line">    <span class="k">throw</span> <span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Access not granted or expired.&#39;</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getToken</span><span class="p">();</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">token</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<blockquote>
  <p>https://github.com/googleworkspace/apps-script-oauth2/blob/3a2924dd0adc9eaf92e5fd64c242bd93ffb3f3ff/dist/OAuth2.gs#L557</p>
</blockquote>

<p>と定義されていて、どうやら取得したJSONの直下に<code>access_token</code>があることが仮定されています。</p>

<p><a href="https://support.withings.com/hc/en-us/articles/360016745358-Deprecating-access-and-refresh-tokens-endpoints">Withings APIの変更のアナウンス</a>
を見てみると、<code>New response format</code>とあり、<code>the deprecated endpoint</code>を使った場合は
<code>access_token</code>が最上位にいますが、
<code>the new endpoint</code>の場合は<code>body</code>の下にいます。</p>

<p>なので、上の関数のところで<code>token.body.access_token</code>の様にしないといけません。</p>

<p>そっちをいじるのは面倒なので、
<code>getToken()</code>で直接取得したJSONデータをとってきて<code>body.access_token</code>を使うようにします。</p>

<p>一応チェックも入れてあります。</p>

<figure class="code"><figcaption><span>Withings.gs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span></span>  <span class="kd">var</span> <span class="nx">access_token</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">getToken</span><span class="p">().</span><span class="nx">body</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
</span><span class="line">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">access_token</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">reset</span><span class="p">();</span>
</span><span class="line">    <span class="k">throw</span> <span class="ow">new</span> <span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Wrong access_token: &#39;</span> <span class="o">+</span> <span class="nx">access_token</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">Authorization</span><span class="o">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="nx">access_token</span>
</span><span class="line">    <span class="p">},</span>
</span><span class="line">    <span class="nx">payload</span><span class="o">:</span> <span class="nx">payload</span>
</span><span class="line">  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<p>これで取れるようになりました。</p>

<h2 id="access_tokenの仕様">access_tokenの仕様</h2>

<p><a href="https://github.com/googleworkspace/apps-script-oauth2">googleworkspace/apps-script-oauth2</a>
がどれだけ広く使われているか分かりませんが、
素直に使おうとするとこの様に<code>getAccessToken</code>は使えないので
殆どの場合は<code>access_token</code>が最上位にあるようにAPIの返答が組まれているのだと思います。</p>

<p>なぜ変えたのか。。。
この辺の事情よく知りませんが、
最近はそういう方向なのでしょうか?(<code>status</code>的なものをまずは入れたい?)</p>
]]></content>
  </entry>
  
</feed>
